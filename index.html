<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>讀書會進度追蹤系統 v17.3</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        
        :root {
            --primary: #e11d48;
            --primary-dark: #9f1239;
            --bg-main: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        body { 
            font-family: 'Inter', 'Noto+Sans+TC', sans-serif; 
            background-color: var(--bg-main); 
            color: #1e293b;
            -webkit-tap-highlight-color: transparent; 
            line-height: 1.6;
        }

        /* 手機 App 質感陰影與圓角 */
        .app-card { 
            background: var(--card-bg); 
            border-radius: 2rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: transform 0.2s ease;
        }

        .glass-header {
            background: rgba(159, 18, 57, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 動畫效果 */
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        .loading-spinner { 
            border: 2px solid rgba(255,255,255,0.3); 
            border-top: 2px solid white; 
            border-radius: 50%; 
            width: 18px; height: 18px; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 自定義滾動條 */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Who are you 美化 */
        .member-btn { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(8px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .member-btn:active { transform: scale(0.92); background: rgba(255, 255, 255, 0.15); }
        .gradient-bg { background: radial-gradient(circle at top right, #4c0519, #0f172a); }

        /* 進度條美化 */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { height: 10px; background: #e2e8f0; border-radius: 5px; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 24px; width: 24px; 
            background: var(--primary); border-radius: 50%; margin-top: -7px; 
            box-shadow: 0 4px 10px rgba(225, 29, 72, 0.3);
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen shadow-2xl overflow-x-hidden">
    <div id="app" class="flex flex-col min-h-screen relative">
        
        <!-- Member Selection Overlay -->
        <div v-if="!selectedMember" class="fixed inset-0 z-[100] gradient-bg flex flex-col items-center justify-center p-8 animate-slide-up">
            <div class="mb-16 text-center">
                <div class="w-24 h-24 bg-rose-600 rounded-[2.5rem] mx-auto mb-8 flex items-center justify-center shadow-2xl shadow-rose-900/40 rotate-6">
                    <i class="fas fa-book-open text-white text-4xl"></i>
                </div>
                <h1 class="text-white text-4xl font-black tracking-tight mb-3">Who are you?</h1>
                <p class="text-slate-400 text-sm font-medium tracking-wide opacity-80">請選擇您的成員身份以開始</p>
            </div>
            
            <div v-if="isLoadingMembers" class="flex flex-col items-center">
                <div class="loading-spinner w-12 h-12 mb-6"></div>
                <span class="text-slate-500 text-[10px] font-bold uppercase tracking-[0.3em]">正在同步讀書會名單...</span>
            </div>
            
            <div v-else class="grid grid-cols-2 gap-5 w-full max-w-xs">
                <button v-for="m in filteredMembers" :key="m" @click="selectMember(m)" 
                    class="member-btn py-10 rounded-[2.5rem] text-white flex flex-col items-center justify-center space-y-4">
                    <div class="w-14 h-14 rounded-full bg-gradient-to-br from-rose-500 to-rose-700 flex items-center justify-center text-2xl font-black shadow-lg">
                        {{ m.charAt(0) }}
                    </div>
                    <span class="font-bold text-lg tracking-wide">{{ m }}</span>
                </button>
            </div>
            
            <div class="mt-20 text-slate-600 text-[10px] font-bold uppercase tracking-[0.4em]">
                讀書會進度追蹤系統
            </div>
        </div>

        <!-- Header -->
        <header class="glass-header text-white p-6 sticky top-0 z-50 shadow-xl rounded-b-[3rem]">
            <div class="flex justify-between items-center">
                <div @click="selectedMember = null" class="cursor-pointer group">
                    <h1 class="text-2xl font-black tracking-tighter group-active:scale-95 transition-transform">{{ selectedMember }}</h1>
                    <div class="flex items-center mt-1.5">
                        <span class="bg-white/20 px-2 py-0.5 rounded-md text-[9px] font-black uppercase mr-2 tracking-tighter">v17.3</span>
                        <span class="text-[10px] text-rose-100 opacity-70 font-medium">切換成員 <i class="fas fa-chevron-down ml-1 text-[8px]"></i></span>
                    </div>
                </div>
                <div class="text-right">
                    <div v-if="activeTab !== 'dashboard'">
                        <div class="relative inline-block">
                            <select v-model="viewWeek" class="appearance-none bg-rose-800/50 text-white text-xs font-black rounded-xl pl-3 pr-8 py-2 outline-none border border-white/10">
                                <option v-for="w in 53" :key="w-1" :value="w-1">WEEK {{ w-1 }}</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[8px] pointer-events-none opacity-50"></i>
                        </div>
                        <div class="text-[10px] text-rose-200 mt-1.5 font-bold tracking-tight">{{ currentWeekRange }}</div>
                    </div>
                    <div v-else>
                        <div class="text-xs font-black bg-rose-800/50 border border-white/10 px-4 py-2 rounded-xl inline-block">WEEK {{ currentWeekNum }}</div>
                        <div class="text-[10px] text-rose-200 mt-1.5 font-bold tracking-tight">{{ currentWeekRange }}</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-5 pb-32 overflow-y-auto space-y-6">
            
            <!-- Tab 1: Dashboard (Home) -->
            <div v-show="activeTab === 'dashboard'" class="space-y-6 animate-slide-up">
                <!-- Weekly Plan Card -->
                <div class="app-card p-7">
                    <div class="flex items-center justify-between mb-5">
                        <div class="flex items-center">
                            <div class="w-2 h-6 bg-rose-600 rounded-full mr-3"></div>
                            <span class="text-[11px] font-black text-slate-400 uppercase tracking-[0.15em]">本週計畫</span>
                        </div>
                        <button @click="isEditingPlan = !isEditingPlan" class="text-rose-600 text-[10px] font-black uppercase tracking-widest bg-rose-50 px-3 py-1 rounded-full">
                            {{ isEditingPlan ? '取消' : '滾動修正' }}
                        </button>
                    </div>
                    <div v-if="!isEditingPlan">
                        <h2 class="text-xl font-bold text-slate-800 leading-relaxed whitespace-pre-line">{{ getPlanByWeek(currentWeekNum) || '尚未設定本週計畫' }}</h2>
                    </div>
                    <div v-else class="space-y-4">
                        <textarea v-model="tempPlan" rows="4" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-rose-500 transition-all" placeholder="輸入本週目標..."></textarea>
                        <button @click="updatePersonalPlan" :disabled="isSubmitting" class="w-full py-4 bg-slate-900 text-white rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] flex items-center justify-center shadow-lg active:scale-[0.98] transition-all">
                            <div v-if="isSubmitting" class="loading-spinner mr-3"></div>
                            {{ isSubmitting ? '正在儲存...' : '儲存修正' }}
                        </button>
                    </div>
                </div>

                <!-- Timer Card -->
                <div class="app-card p-7 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-rose-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
                    <div class="flex justify-between items-center mb-8 relative z-10">
                        <h3 class="font-black text-slate-800 uppercase text-xs tracking-[0.15em]">專注計時</h3>
                        <div class="flex bg-slate-100 p-1.5 rounded-2xl">
                            <button @click="timerMode = 'auto'" :class="timerMode === 'auto' ? 'bg-white shadow-md text-rose-600' : 'text-slate-400'" class="px-4 py-1.5 rounded-xl text-[10px] font-black transition-all">自動</button>
                            <button @click="timerMode = 'manual'" :class="timerMode === 'manual' ? 'bg-white shadow-md text-rose-600' : 'text-slate-400'" class="px-4 py-1.5 rounded-xl text-[10px] font-black transition-all">手動</button>
                        </div>
                    </div>
                    
                    <div v-if="timerMode === 'auto'" class="text-center relative z-10">
                        <div class="relative w-48 h-48 mx-auto mb-8 flex items-center justify-center">
                            <svg class="w-full h-full -rotate-90">
                                <circle cx="96" cy="96" r="88" stroke="currentColor" stroke-width="6" fill="transparent" class="text-slate-100" />
                                <circle cx="96" cy="96" r="88" stroke="currentColor" stroke-width="8" fill="transparent" class="text-rose-600" 
                                    :stroke-dasharray="553" :stroke-dashoffset="553 * (1 - timerProgress)" stroke-linecap="round" style="transition: stroke-dashoffset 0.5s ease;" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-4xl font-black text-slate-800 tracking-tighter">{{ formatTime(currentSeconds) }}</span>
                                <div class="mt-3 flex flex-col space-y-2">
                                    <button @click="toggleTimer" :class="isRunning ? 'bg-orange-100 text-orange-600' : 'bg-rose-100 text-rose-600'" class="px-6 py-2 rounded-full text-[11px] font-black uppercase tracking-widest transition-all active:scale-90">
                                        {{ isRunning ? 'PAUSE' : 'START' }}
                                    </button>
                                    <button v-if="!isRunning && currentSeconds > 0" @click="submitTimerOnly(true)" :disabled="isSubmitting" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest hover:text-slate-600 transition-colors">
                                        提交時數
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div v-else class="space-y-6 py-4 relative z-10">
                        <div class="flex items-center justify-center space-x-6">
                            <button @click="manualHours = Math.max(0, manualHours - 0.5)" class="w-14 h-14 rounded-2xl bg-slate-50 text-slate-400 text-xl font-bold hover:bg-slate-100 transition-colors">-</button>
                            <div class="text-center">
                                <input v-model="manualHours" type="number" step="0.5" class="w-24 text-4xl font-black text-center bg-transparent outline-none text-slate-800">
                                <div class="text-[10px] font-black text-slate-300 uppercase mt-1">Hours</div>
                            </div>
                            <button @click="manualHours += 0.5" class="w-14 h-14 rounded-2xl bg-slate-50 text-slate-400 text-xl font-bold hover:bg-slate-100 transition-colors">+</button>
                        </div>
                        <button @click="addManualTime" :disabled="isSubmitting" class="w-full py-4 bg-slate-900 text-white rounded-2xl text-[11px] font-black uppercase tracking-[0.2em] shadow-lg active:scale-[0.98] transition-all">
                            提交手動時數
                        </button>
                    </div>
                </div>

                <!-- Daily Report Card -->
                <div class="app-card p-7 space-y-6">
                    <div class="flex justify-between items-center">
                        <h3 class="font-black text-slate-800 text-xs uppercase tracking-[0.15em] flex items-center">
                            <i class="fas fa-feather-alt text-rose-500 mr-3"></i> 每日輕回報
                        </h3>
                        <input type="date" v-model="customDate" class="text-[11px] font-black text-slate-500 bg-slate-100 px-3 py-1.5 rounded-xl outline-none border-none">
                    </div>
                    
                    <div class="space-y-5">
                        <textarea v-model="dailyInput" rows="3" class="w-full p-5 bg-slate-50 border border-slate-100 rounded-[1.5rem] focus:ring-2 focus:ring-rose-500 outline-none text-sm transition-all placeholder:text-slate-300" placeholder="今天完成了哪些進度？"></textarea>
                        
                        <div class="p-5 bg-slate-50 rounded-[1.5rem] space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">今日完成率</label>
                                <span class="text-rose-600 font-black text-lg">{{ dailyCompletion }}%</span>
                            </div>
                            <input v-model="dailyCompletion" type="range" min="1" max="100" class="w-full">
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">今日不熟觀念</label>
                                <input v-model="dailyWeakPoint" type="text" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm outline-none focus:ring-1 focus:ring-rose-200" placeholder="例如：法規第12條...">
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">落差原因</label>
                                <input v-model="dailyGapReason" type="text" class="w-full p-4 bg-slate-50 border border-slate-100 rounded-2xl text-sm outline-none focus:ring-1 focus:ring-rose-200" placeholder="例如：加班、內容太難...">
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-rose-50/50 rounded-2xl border border-rose-100/50">
                            <span class="text-[11px] font-black text-rose-900/60 uppercase tracking-tight">需要讀書會支援？</span>
                            <div class="flex space-x-2">
                                <button @click="dailyNeedSupport = false" :class="!dailyNeedSupport ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400'" class="px-4 py-1.5 rounded-xl text-[10px] font-black transition-all">否</button>
                                <button @click="dailyNeedSupport = true" :class="dailyNeedSupport ? 'bg-rose-600 text-white shadow-lg shadow-rose-200' : 'text-slate-400'" class="px-4 py-1.5 rounded-xl text-[10px] font-black transition-all">是</button>
                            </div>
                        </div>
                        
                        <div v-if="dailyNeedSupport" class="animate-slide-up">
                            <input v-model="dailySupportDetail" type="text" class="w-full p-4 bg-rose-50 border border-rose-100 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-rose-500" placeholder="請說明需要的支援...">
                        </div>
                    </div>

                    <button @click="addDailyLog(true)" :disabled="isSubmitting" class="w-full py-5 bg-rose-600 text-white rounded-[1.5rem] text-sm font-black shadow-xl shadow-rose-200 active:scale-[0.98] transition-all flex items-center justify-center">
                        <div v-if="isSubmitting" class="loading-spinner mr-3"></div>
                        {{ isSubmitting ? '正在提交...' : '記錄今日進度' }}
                    </button>
                </div>
            </div>

            <!-- Tab 2: Weekly Report -->
            <div v-show="activeTab === 'report'" class="space-y-6 animate-slide-up">
                <div class="app-card p-8">
                    <div class="p-7 bg-slate-900 rounded-[2.5rem] text-white mb-8 shadow-2xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-white/5 rounded-full -mr-12 -mt-12"></div>
                        <label class="block text-[10px] font-black text-rose-400 uppercase tracking-[0.2em] mb-3">下週預計進度</label>
                        <div class="text-xl font-bold leading-relaxed">{{ nextMemberPlan || '尚未設定下週計畫' }}</div>
                    </div>

                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-3xl font-black text-slate-800 tracking-tighter">WEEK {{ viewWeek }}</h2>
                            <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-1">數據總覽</p>
                        </div>
                        <button @click="fetchInitialData" class="p-3 bg-slate-50 text-slate-400 rounded-2xl hover:text-rose-600 transition-colors">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-5 mb-8">
                        <div class="p-6 bg-slate-50 rounded-[2rem] border border-slate-100">
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">本週總時數</div>
                            <div class="text-3xl font-black text-slate-800">{{ currentMemberStats.totalHours || 0 }} <span class="text-sm text-slate-300">HR</span></div>
                        </div>
                        <div class="p-6 bg-rose-50 rounded-[2rem] border border-rose-100">
                            <div class="text-[10px] font-black text-rose-400 uppercase tracking-widest mb-2">平均完成率</div>
                            <div class="text-3xl font-black text-rose-600">{{ currentMemberStats.completionRate || 0 }}<span class="text-sm opacity-50">%</span></div>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <section>
                            <div class="flex items-center mb-3">
                                <div class="w-1.5 h-4 bg-slate-300 rounded-full mr-2"></div>
                                <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest">本週規劃進度</label>
                            </div>
                            <div class="p-6 bg-slate-50 rounded-[1.5rem] text-sm font-bold text-slate-700 whitespace-pre-line leading-relaxed">{{ currentMemberPlan }}</div>
                        </section>

                        <section>
                            <div class="flex items-center mb-3">
                                <div class="w-1.5 h-4 bg-rose-500 rounded-full mr-2"></div>
                                <label class="text-[11px] font-black text-slate-400 uppercase tracking-widest">本週進度彙整</label>
                            </div>
                            <div class="p-6 bg-white border border-slate-100 rounded-[1.5rem] text-sm leading-relaxed text-slate-600 whitespace-pre-line min-h-[120px]">
                                {{ currentMemberStats.actual || '尚未有每日回報' }}
                            </div>
                        </section>

                        <div class="grid grid-cols-1 gap-5">
                            <div class="p-6 bg-rose-50/30 rounded-[1.5rem] border border-rose-100/50">
                                <label class="block text-[10px] font-black text-rose-400 uppercase tracking-widest mb-2">累計不熟觀念</label>
                                <div class="text-sm font-bold text-rose-900/70">{{ currentMemberStats.weakPoint || '無' }}</div>
                            </div>
                            <div class="p-6 bg-slate-50 rounded-[1.5rem]">
                                <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">累計落差原因</label>
                                <div class="text-sm font-bold text-slate-500">{{ currentMemberStats.gapReason || '無' }}</div>
                            </div>
                        </div>

                        <div v-if="currentMemberStats.needSupport" class="p-6 bg-amber-50 border border-amber-100 rounded-[1.5rem] animate-pulse">
                            <div class="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-2">⚠️ 需要讀書會支援</div>
                            <div class="text-sm font-bold text-amber-900">{{ currentMemberStats.supportDetail }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Stats -->
            <div v-show="activeTab === 'stats'" class="space-y-6 animate-slide-up">
                <div class="flex items-center justify-between px-2">
                    <div>
                        <h2 class="text-2xl font-black text-slate-800 tracking-tighter">戰況看板</h2>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em] mt-1">WEEK {{ viewWeek }} 全員進度</p>
                    </div>
                    <button @click="fetchInitialData" :disabled="isSubmitting" class="flex items-center space-x-2 bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-100 active:scale-95 transition-all">
                        <div v-if="isSubmitting" class="loading-spinner border-rose-600 border-t-transparent w-3 h-3"></div>
                        <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Refresh</span>
                    </button>
                </div>

                <div class="app-card p-6">
                    <canvas id="completionChart" class="max-h-[250px]"></canvas>
                </div>

                <div class="space-y-5">
                    <div v-for="(member, index) in sortedStatsList" :key="index" class="app-card p-7 relative overflow-hidden">
                        <div v-if="index === 0" class="absolute top-0 right-0 bg-rose-600 text-white text-[8px] font-black px-4 py-1 rounded-bl-xl uppercase tracking-widest shadow-lg">MVP</div>
                        
                        <div class="flex justify-between items-start mb-6">
                            <div class="flex items-center">
                                <div class="w-12 h-12 rounded-2xl bg-slate-900 text-white flex items-center justify-center font-black text-xl mr-4 shadow-xl">
                                    {{ index + 1 }}
                                </div>
                                <div>
                                    <div class="font-black text-slate-800 text-xl tracking-tight">{{ member.name }}</div>
                                    <div class="flex items-center mt-1">
                                        <div class="w-20 h-1.5 bg-slate-100 rounded-full mr-2 overflow-hidden">
                                            <div class="h-full bg-rose-500 rounded-full" :style="{width: member.completionRate + '%'}"></div>
                                        </div>
                                        <span class="text-[9px] text-slate-400 font-black uppercase">達成率 {{ member.completionRate }}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-black text-rose-600 tracking-tighter">{{ member.totalHours }}<span class="text-xs ml-1 opacity-40">HR</span></div>
                                <div class="text-[9px] text-slate-300 font-black uppercase tracking-tighter mt-1">Power: {{ member.powerScore.toFixed(1) }}</div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div class="p-5 bg-slate-50 rounded-2xl text-[12px] leading-relaxed">
                                <span class="font-black text-slate-300 uppercase text-[9px] block mb-2 tracking-widest">本週進度彙整</span>
                                <div class="text-slate-600 font-medium whitespace-pre-line">{{ member.actual || '尚未回報' }}</div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div class="p-4 bg-rose-50/50 rounded-2xl text-[11px]">
                                    <span class="font-black text-rose-300 uppercase text-[8px] block mb-1 tracking-widest">不熟觀念</span>
                                    <div class="text-rose-800 font-bold truncate">{{ member.weakPoint || '無' }}</div>
                                </div>
                                <div class="p-4 bg-slate-50 rounded-2xl text-[11px]">
                                    <span class="font-black text-slate-300 uppercase text-[8px] block mb-1 tracking-widest">落差原因</span>
                                    <div class="text-slate-500 font-bold truncate">{{ member.gapReason || '無' }}</div>
                                </div>
                            </div>

                            <div v-if="member.needSupport" class="p-4 bg-amber-50 border border-amber-100 rounded-2xl flex items-center">
                                <i class="fas fa-exclamation-triangle text-amber-500 mr-3 text-xs"></i>
                                <div class="text-[11px] font-bold text-amber-900 truncate">{{ member.supportDetail }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/80 backdrop-blur-xl border-t border-slate-100 flex justify-around items-center py-5 px-10 safe-area-bottom z-50 rounded-t-[3rem] shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
            <button @click="activeTab = 'dashboard'" :class="activeTab === 'dashboard' ? 'text-rose-600 scale-110' : 'text-slate-300'" class="flex flex-col items-center transition-all duration-300">
                <i class="fas fa-house-user text-xl"></i>
                <span class="text-[9px] mt-1.5 font-black uppercase tracking-[0.15em]">Home</span>
            </button>
            <button @click="activeTab = 'report'" :class="activeTab === 'report' ? 'text-rose-600 scale-110' : 'text-slate-300'" class="flex flex-col items-center transition-all duration-300">
                <i class="fas fa-chart-pie text-xl"></i>
                <span class="text-[9px] mt-1.5 font-black uppercase tracking-[0.15em]">Report</span>
            </button>
            <button @click="activeTab = 'stats'" :class="activeTab === 'stats' ? 'text-rose-600 scale-110' : 'text-slate-300'" class="flex flex-col items-center transition-all duration-300">
                <i class="fas fa-trophy text-xl"></i>
                <span class="text-[9px] mt-1.5 font-black uppercase tracking-[0.15em]">Stats</span>
            </button>
        </nav>

        <!-- Success Toast -->
        <div v-if="showToast" class="fixed top-10 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-[2rem] shadow-2xl z-[100] flex items-center animate-slide-up">
            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-3">
                <i class="fas fa-check text-[10px]"></i>
            </div>
            <span class="text-xs font-black uppercase tracking-[0.2em]">Success</span>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const scriptURL = 'https://script.google.com/macros/s/AKfycbxwnoqGxXmVDr7dB4xUZMIMzSWiJhEF-T_iyeX2ZjxWrSwNopR3u0j3JGoIicVtN-1l/exec';
                const START_DATE_CONFIG = '2025-12-29'; 

                const activeTab = ref('dashboard');
                const selectedMember = ref(null);
                const members = ref([]);
                const isLoadingMembers = ref(true);
                const timerMode = ref('auto');
                const isRunning = ref(false);
                const currentSeconds = ref(0);
                const totalSeconds = ref(0);
                const manualHours = ref(0);
                const timerInterval = ref(null);
                const showToast = ref(false);
                const isSubmitting = ref(false);
                const isEditingPlan = ref(false);
                const tempPlan = ref('');
                const hasNewData = ref(false);
                const viewWeek = ref(0);
                
                const dailyInput = ref('');
                const dailyCompletion = ref(100);
                const dailyWeakPoint = ref('');
                const dailyGapReason = ref('');
                const dailyNeedSupport = ref(false);
                const dailySupportDetail = ref('');
                const customDate = ref(new Date().toLocaleDateString('en-CA'));
                
                const personalPlans = ref({});
                const statsList = ref([]);
                let chartInstance = null;

                // 過濾空白成員與標題
                const filteredMembers = computed(() => {
                    return members.value.filter(m => 
                        m && 
                        typeof m === 'string' && 
                        m.trim() !== '' && 
                        m.trim() !== 'Name'
                    );
                });

                const currentWeekNum = computed(() => {
                    const start = new Date(START_DATE_CONFIG + 'T00:00:00');
                    const now = new Date();
                    const diff = now.getTime() - start.getTime();
                    const week = Math.floor(diff / (7 * 24 * 60 * 60 * 1000));
                    return week >= 0 ? week : 0;
                });

                const currentWeekRange = computed(() => {
                    const start = new Date(START_DATE_CONFIG + 'T00:00:00');
                    const targetStart = new Date(start.getTime() + viewWeek.value * 7 * 24 * 60 * 60 * 1000);
                    const targetEnd = new Date(targetStart.getTime() + 6 * 24 * 60 * 60 * 1000 + 23 * 60 * 60 * 1000 + 59 * 60 * 1000);
                    return `${targetStart.toLocaleDateString('zh-TW', {month:'short', day:'numeric'})} - ${targetEnd.toLocaleDateString('zh-TW', {month:'short', day:'numeric'})}`;
                });

                const currentMemberPlan = computed(() => getPlanByWeek(viewWeek.value));
                const nextMemberPlan = computed(() => getPlanByWeek(viewWeek.value + 1));

                const getPlanByWeek = (w) => {
                    if (!selectedMember.value || !personalPlans.value[selectedMember.value]) return '';
                    return personalPlans.value[selectedMember.value][w] || '';
                };

                const currentMemberStats = computed(() => {
                    if (!selectedMember.value) return {};
                    return statsList.value.find(m => m.name === selectedMember.value) || {};
                });

                const sortedStatsList = computed(() => {
                    const maxHours = Math.max(...statsList.value.map(m => parseFloat(m.totalHours) || 0), 1);
                    return statsList.value.map(m => ({
                        ...m,
                        powerScore: (parseFloat(m.completionRate) + (parseFloat(m.totalHours) / maxHours) * 100) / 2
                    })).sort((a, b) => b.powerScore - a.powerScore);
                });

                const timerProgress = computed(() => (currentSeconds.value % 3600) / 3600);

                const selectMember = (m) => {
                    selectedMember.value = m;
                    viewWeek.value = currentWeekNum.value;
                    tempPlan.value = getPlanByWeek(currentWeekNum.value);
                    loadData();
                };

                const formatTime = (s) => {
                    const mins = Math.floor(s / 60);
                    const secs = s % 60;
                    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                };

                const formatTotalTime = (s) => (s / 3600).toFixed(1);

                const toggleTimer = () => {
                    if (isRunning.value) { clearInterval(timerInterval.value); }
                    else { timerInterval.value = setInterval(() => { currentSeconds.value++; totalSeconds.value++; saveData(); }, 1000); }
                    isRunning.value = !isRunning.value;
                };

                const submitTimerOnly = async (shouldPrompt = false) => {
                    isSubmitting.value = true;
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'submitDaily',
                                name: selectedMember.value,
                                totalHours: formatTotalTime(totalSeconds.value),
                                plan: getPlanByWeek(currentWeekNum.value),
                                isTimerOnly: true,
                                completion: 0,
                                content: '',
                                gapReason: '',
                                weakPoint: '',
                                needSupport: false,
                                supportDetail: ''
                            })
                        });
                        currentSeconds.value = 0;
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                        hasNewData.value = true;
                        fetchInitialData();
                        if (shouldPrompt && confirm('時數提交成功！是否要順便記錄今日進度？')) {
                            if (!dailyInput.value) { alert('請填寫今日進度內容'); } 
                            else { addDailyLog(false); }
                        }
                    } catch (e) { alert('提交失敗'); }
                    finally { isSubmitting.value = false; }
                };

                const addManualTime = async () => {
                    totalSeconds.value += manualHours.value * 3600;
                    manualHours.value = 0;
                    await submitTimerOnly(true);
                    saveData();
                };

                const addDailyLog = async (shouldPrompt = false) => {
                    if (!dailyInput.value) { alert('請填寫今日進度內容'); return; }
                    isSubmitting.value = true;
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'submitDaily',
                                name: selectedMember.value,
                                date: customDate.value,
                                totalHours: formatTotalTime(totalSeconds.value),
                                plan: getPlanByWeek(currentWeekNum.value),
                                content: dailyInput.value,
                                completion: dailyCompletion.value,
                                weakPoint: dailyWeakPoint.value,
                                gapReason: dailyGapReason.value,
                                needSupport: dailyNeedSupport.value,
                                supportDetail: dailySupportDetail.value,
                                isTimerOnly: false
                            })
                        });
                        dailyInput.value = '';
                        dailyWeakPoint.value = '';
                        dailyGapReason.value = '';
                        dailyNeedSupport.value = false;
                        dailySupportDetail.value = '';
                        dailyCompletion.value = 100;
                        customDate.value = new Date().toLocaleDateString('en-CA');
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                        hasNewData.value = true;
                        saveData();
                        fetchInitialData();
                        if (shouldPrompt && confirm('進度記錄成功！是否要順便提交專注時數？')) {
                            if (totalSeconds.value === 0 && currentSeconds.value === 0) { alert('請先開始計時或手動填寫時數'); } 
                            else { submitTimerOnly(false); }
                        }
                    } catch (e) { alert('提交失敗'); }
                    finally { isSubmitting.value = false; }
                };

                const updatePersonalPlan = async () => {
                    isSubmitting.value = true;
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({ action: 'updatePlan', name: selectedMember.value, week: currentWeekNum.value, topic: tempPlan.value })
                        });
                        if (!personalPlans.value[selectedMember.value]) personalPlans.value[selectedMember.value] = {};
                        personalPlans.value[selectedMember.value][currentWeekNum.value] = tempPlan.value;
                        isEditingPlan.value = false;
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                    } catch (e) { alert('更新失敗'); }
                    finally { isSubmitting.value = false; }
                };

                const fetchInitialData = async () => {
                    isSubmitting.value = true;
                    try {
                        const res = await fetch(`${scriptURL}?action=getInitialData&week=${viewWeek.value}`);
                        const data = await res.json();
                        personalPlans.value = data.personalPlans;
                        statsList.value = data.statsList;
                        members.value = data.members;
                        isLoadingMembers.value = false;
                        hasNewData.value = false;
                        nextTick(() => renderChart());
                    } catch (e) { console.error('獲取資料失敗', e); }
                    finally { isSubmitting.value = false; }
                };

                const renderChart = () => {
                    const ctx = document.getElementById('completionChart');
                    if (!ctx) return;
                    if (chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: statsList.value.map(m => m.name),
                            datasets: [
                                { label: '達成率 (%)', data: statsList.value.map(m => m.completionRate), backgroundColor: 'rgba(225, 29, 72, 0.8)', borderRadius: 12, yAxisID: 'y' },
                                { label: '時數 (HR)', data: statsList.value.map(m => m.totalHours), backgroundColor: 'rgba(15, 23, 42, 0.8)', borderRadius: 12, yAxisID: 'y1' }
                            ]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { font: { weight: 'bold', size: 10 } } } },
                            scales: { 
                                y: { type: 'linear', position: 'left', beginAtZero: true, max: 100, grid: { display: false }, ticks: { font: { size: 9 } } },
                                y1: { type: 'linear', position: 'right', beginAtZero: true, grid: { display: false }, ticks: { font: { size: 9 } } },
                                x: { grid: { display: false }, ticks: { font: { weight: 'bold', size: 10 } } }
                            } 
                        }
                    });
                };

                const saveData = () => {
                    if (!selectedMember.value) return;
                    localStorage.setItem(`fire_v17_${selectedMember.value}`, JSON.stringify({
                        totalSeconds: totalSeconds.value,
                        lastUpdate: new Date().toDateString()
                    }));
                };

                const loadData = () => {
                    const saved = localStorage.getItem(`fire_v17_${selectedMember.value}`);
                    if (saved) {
                        const data = JSON.parse(saved);
                        const today = new Date();
                        const day = today.getDay();
                        const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                        const startOfWeek = new Date(today.setDate(diff));
                        startOfWeek.setHours(0,0,0,0);
                        if (new Date(data.lastUpdate) < startOfWeek) { totalSeconds.value = 0; } 
                        else { totalSeconds.value = data.totalSeconds || 0; }
                    } else { totalSeconds.value = 0; }
                };

                watch(activeTab, (newTab) => { 
                    if (newTab === 'dashboard') viewWeek.value = currentWeekNum.value;
                    fetchInitialData(); 
                });
                watch(viewWeek, () => { fetchInitialData(); });

                onMounted(async () => { 
                    await fetchInitialData();
                    viewWeek.value = currentWeekNum.value;
                    setInterval(() => {
                        const now = new Date().toLocaleDateString('en-CA');
                        if (customDate.value !== now && !isSubmitting.value) customDate.value = now;
                    }, 60000);
                });

                return {
                    activeTab, selectedMember, members, filteredMembers, isLoadingMembers, timerMode, isRunning, currentSeconds, totalSeconds, manualHours,
                    timerProgress, dailyInput, dailyCompletion, dailyWeakPoint, dailyGapReason, dailyNeedSupport, dailySupportDetail, customDate, personalPlans, statsList, sortedStatsList, isEditingPlan, tempPlan, hasNewData, isSubmitting, viewWeek,
                    currentWeekNum, currentWeekRange, currentMemberPlan, nextMemberPlan, currentMemberStats, getPlanByWeek,
                    selectMember, formatTime, formatTotalTime, toggleTimer, submitTimerOnly, addManualTime, addDailyLog, updatePersonalPlan, fetchInitialData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
