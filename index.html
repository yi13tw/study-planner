<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消防設備士備考極致版 v5</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 1); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-ring { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen shadow-2xl bg-slate-50">
    <div id="app" class="flex flex-col min-h-screen relative">
        
        <!-- Member Selection Overlay -->
        <div v-if="!selectedMember" class="fixed inset-0 z-[100] bg-slate-900/95 flex flex-col items-center justify-center p-8 animate-fade-in">
            <h1 class="text-white text-2xl font-black mb-8 tracking-widest uppercase">Who are you?</h1>
            <div class="grid grid-cols-2 gap-4 w-full">
                <button v-for="m in members" :key="m" @click="selectMember(m)" 
                    class="py-6 bg-white/10 border border-white/20 rounded-3xl text-white font-bold hover:bg-white/20 transition-all active:scale-95">
                    {{ m }}
                </button>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-red-800 text-white p-5 sticky top-0 z-50 shadow-lg rounded-b-[2.5rem]">
            <div class="flex justify-between items-center">
                <div @click="selectedMember = null" class="cursor-pointer">
                    <h1 class="text-xl font-black tracking-tight">{{ selectedMember }} 的儀表板</h1>
                    <div class="flex items-center mt-1">
                        <span class="bg-white/20 px-2 py-0.5 rounded text-[9px] font-bold uppercase mr-2">ULTIMATE v5</span>
                        <span class="text-[10px] text-red-100 opacity-80">切換成員 <i class="fas fa-chevron-down ml-1"></i></span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-black">WEEK {{ currentWeekNum }}</div>
                    <div class="text-[10px] text-red-200">{{ currentWeekRange }}</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4 pb-28 overflow-y-auto space-y-5">
            
            <!-- Tab 1: Dashboard (儀表板) -->
            <div v-show="activeTab === 'dashboard'" class="space-y-5 animate-fade-in">
                
                <!-- 個人化 14 週計畫 -->
                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] font-black text-red-600 uppercase tracking-widest">當週個人計畫</span>
                        <button @click="isEditingPlan = !isEditingPlan" class="text-slate-400 text-[10px] font-bold uppercase">
                            {{ isEditingPlan ? '取消' : '滾動修正' }}
                        </button>
                    </div>
                    <div v-if="!isEditingPlan">
                        <h2 class="text-xl font-bold text-slate-800 leading-tight">{{ currentMemberPlan || '尚未設定本週計畫' }}</h2>
                    </div>
                    <div v-else class="space-y-3">
                        <textarea v-model="tempPlan" rows="2" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-red-600"></textarea>
                        <button @click="updatePersonalPlan" class="w-full py-2 bg-slate-800 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest">儲存修正</button>
                    </div>
                </div>

                <!-- 雙軌計時 -->
                <div class="glass-card rounded-[2.5rem] p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-slate-800 uppercase text-sm tracking-wider">專注計時</h3>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button @click="timerMode = 'auto'" :class="timerMode === 'auto' ? 'bg-white shadow-sm text-red-600' : 'text-slate-400'" class="px-3 py-1 rounded-lg text-[10px] font-bold transition-all">自動</button>
                            <button @click="timerMode = 'manual'" :class="timerMode === 'manual' ? 'bg-white shadow-sm text-red-600' : 'text-slate-400'" class="px-3 py-1 rounded-lg text-[10px] font-bold transition-all">手動</button>
                        </div>
                    </div>

                    <div v-if="timerMode === 'auto'" class="text-center">
                        <div class="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-full h-full progress-ring">
                                <circle cx="80" cy="80" r="74" stroke="currentColor" stroke-width="4" fill="transparent" class="text-slate-100" />
                                <circle cx="80" cy="80" r="74" stroke="currentColor" stroke-width="6" fill="transparent" class="text-red-600" 
                                    :stroke-dasharray="465" :stroke-dashoffset="465 * (1 - timerProgress)" stroke-linecap="round" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-3xl font-mono font-black text-slate-800">{{ formatTime(currentSeconds) }}</span>
                                <button @click="toggleTimer" :class="isRunning ? 'text-orange-500' : 'text-red-600'" class="mt-1 text-[10px] font-black uppercase tracking-widest">{{ isRunning ? 'PAUSE' : 'START' }}</button>
                            </div>
                        </div>
                    </div>
                    <div v-else class="space-y-4 py-2">
                        <div class="flex items-center justify-center space-x-4">
                            <button @click="manualHours = Math.max(0, manualHours - 0.5)" class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600">-</button>
                            <input v-model="manualHours" type="number" step="0.5" class="w-20 text-2xl font-black text-center bg-transparent outline-none">
                            <button @click="manualHours += 0.5" class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600">+</button>
                        </div>
                        <button @click="addManualTime" class="w-full py-3 bg-slate-800 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest">新增時數</button>
                    </div>
                </div>

                <!-- 每日輕回報 -->
                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-200 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-black text-slate-800 text-sm uppercase tracking-wider flex items-center">
                            <i class="fas fa-bolt text-yellow-500 mr-2"></i> 每日輕回報
                        </h3>
                        <input type="date" v-model="customDate" class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-lg outline-none">
                    </div>
                    
                    <textarea v-model="dailyInput" rows="2" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-red-600 outline-none text-sm transition-all" placeholder="今天讀了什麼？"></textarea>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[9px] font-black text-slate-400 uppercase mb-1">今日完成率 (%)</label>
                            <input v-model="dailyCompletion" type="number" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold">
                        </div>
                        <div>
                            <label class="block text-[9px] font-black text-slate-400 uppercase mb-1">今日不熟觀念</label>
                            <input v-model="dailyWeakPoint" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-[9px] font-black text-slate-400 uppercase mb-1">落差原因 (若有)</label>
                        <input v-model="dailyGapReason" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                    </div>

                    <button @click="addDailyLog" class="w-full py-4 bg-red-600 text-white rounded-2xl text-xs font-bold shadow-md active:scale-95 transition-all">記錄今日進度</button>
                </div>
            </div>

            <!-- Tab 2: Weekly Report (週日結報) -->
            <div v-show="activeTab === 'report'" class="space-y-4 animate-fade-in">
                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-black text-slate-800 mb-6">週日總結報</h2>
                    
                    <div class="p-4 bg-red-50 rounded-2xl border border-red-100 mb-6">
                        <div class="text-[10px] font-black text-red-600 uppercase mb-1">本週規劃進度</div>
                        <div class="text-sm font-bold text-slate-800">{{ currentMemberPlan }}</div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">本週彙整進度 (自動統整)</label>
                            <textarea v-model="form.actual" rows="5" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm leading-relaxed"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <div class="text-[9px] font-black text-slate-400 uppercase mb-1">平均完成率</div>
                                <div class="text-xl font-black text-red-600">{{ form.completionRate }}%</div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-2xl">
                                <div class="text-[9px] font-black text-slate-400 uppercase mb-1">累計不熟觀念</div>
                                <div class="text-[10px] font-bold text-slate-600 truncate">{{ form.weakPoint }}</div>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-4 bg-slate-900 rounded-2xl text-white">
                            <span class="text-xs font-bold">需要讀書會支援？</span>
                            <button @click="form.needSupport = !form.needSupport" :class="form.needSupport ? 'bg-red-600' : 'bg-white/20'" class="px-6 py-2 rounded-xl text-[10px] font-black uppercase transition-all">
                                {{ form.needSupport ? '是' : '否' }}
                            </button>
                        </div>
                        
                        <div v-if="form.needSupport">
                            <input v-model="form.supportDetail" type="text" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm" placeholder="請說明需要的支援...">
                        </div>

                        <button @click="submitToGoogleSheets" :disabled="isSubmitting" class="w-full py-5 bg-red-700 text-white rounded-[2rem] font-black shadow-2xl active:scale-95 transition-all uppercase tracking-widest text-sm">
                            {{ isSubmitting ? 'SENDING...' : '提交本週結報' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Stats (全透明看板) -->
            <div v-show="activeTab === 'stats'" class="space-y-5 animate-fade-in">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-xl font-black text-slate-800 uppercase tracking-wider">本週戰況看板</h2>
                    <button @click="fetchInitialData" class="text-red-600 text-[10px] font-bold uppercase tracking-widest bg-red-50 px-3 py-1 rounded-full">Refresh</button>
                </div>

                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-200">
                    <canvas id="completionChart"></canvas>
                </div>

                <div class="space-y-4">
                    <div v-for="(member, index) in statsList" :key="index" class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-200">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-2xl bg-red-700 text-white flex items-center justify-center font-black mr-3 shadow-lg">{{ index + 1 }}</div>
                                <div>
                                    <div class="font-black text-slate-800 text-lg">{{ member.name }}</div>
                                    <div class="text-[9px] text-slate-400 font-bold uppercase">達成率 {{ member.completionRate }}%</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-red-600">{{ member.totalHours }}<span class="text-[10px] ml-1">HR</span></div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <div class="p-3 bg-slate-50 rounded-2xl text-xs text-slate-600 leading-relaxed">
                                <div class="text-[9px] font-bold text-slate-400 uppercase mb-1">本週進度</div>
                                {{ member.actual || '尚未回報' }}
                            </div>
                            <div v-if="member.weakPoint" class="p-3 bg-red-50 rounded-2xl text-xs text-red-700 leading-relaxed">
                                <div class="text-[9px] font-bold text-red-400 uppercase mb-1">不熟觀念</div>
                                {{ member.weakPoint }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-md border-t border-slate-200 flex justify-around items-center py-4 px-8 safe-area-bottom z-50 rounded-t-[2.5rem] shadow-2xl">
            <button @click="activeTab = 'dashboard'" :class="activeTab === 'dashboard' ? 'text-red-700' : 'text-slate-300'" class="flex flex-col items-center transition-all">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[8px] mt-1 font-black uppercase tracking-widest">Home</span>
            </button>
            <button @click="activeTab = 'report'" :class="activeTab === 'report' ? 'text-red-700' : 'text-slate-300'" class="flex flex-col items-center transition-all">
                <i class="fas fa-edit text-xl"></i>
                <span class="text-[8px] mt-1 font-black uppercase tracking-widest">Report</span>
            </button>
            <button @click="activeTab = 'stats'" :class="activeTab === 'stats' ? 'text-red-700' : 'text-slate-300'" class="flex flex-col items-center transition-all">
                <i class="fas fa-chart-bar text-xl"></i>
                <span class="text-[8px] mt-1 font-black uppercase tracking-widest">Stats</span>
            </button>
        </nav>

        <!-- Success Toast -->
        <div v-if="showToast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-full shadow-2xl z-[100] flex items-center animate-fade-in">
            <i class="fas fa-check-circle text-green-400 mr-3"></i> 
            <span class="text-xs font-black uppercase tracking-widest">Success</span>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const activeTab = ref('dashboard');
                const selectedMember = ref(null);
                const members = ['kurt', '郁舒', '和憲', '宜姍'];
                const timerMode = ref('auto');
                const isRunning = ref(false);
                const currentSeconds = ref(0);
                const totalSeconds = ref(0);
                const manualHours = ref(0);
                const timerInterval = ref(null);
                const showToast = ref(false);
                const isSubmitting = ref(false);
                const isEditingPlan = ref(false);
                const tempPlan = ref('');
                
                const dailyInput = ref('');
                const dailyCompletion = ref(100);
                const dailyWeakPoint = ref('');
                const dailyGapReason = ref('');
                const customDate = ref(new Date().toISOString().substr(0, 10));
                
                const dailyLogs = ref([]);
                const personalPlans = ref({});
                const statsList = ref([]);
                let chartInstance = null;

                const form = ref({ name: '', plan: '', actual: '', completionRate: 0, gapReason: '', weakPoint: '', nextStrategy: '', needSupport: false, supportDetail: '' });

                const scriptURL = 'https://script.google.com/macros/s/AKfycbyqN8BE5sD2bDjm49f62xbd4sYTlDgB52ZgveFL90JR7UyZ1K6h24onYEW9ldpLHXRd/exec';

                const currentWeekNum = computed(() => {
                    const start = new Date('2025-12-31'); // 修改為今日啟動，以便測試
                    const now = new Date();
                    const diff = now - start;
                    const week = Math.ceil(diff / (7 * 24 * 60 * 60 * 1000));
                    return week > 0 ? week : 1;
                });

                const currentWeekRange = computed(() => {
                    const now = new Date();
                    const first = now.getDate() - now.getDay() + (now.getDay() === 0 ? -6 : 1);
                    const last = first + 6;
                    const firstDay = new Date(now.setDate(first)).toLocaleDateString('zh-TW', {month:'short', day:'numeric'});
                    const lastDay = new Date(now.setDate(last)).toLocaleDateString('zh-TW', {month:'short', day:'numeric'});
                    return `${firstDay} - ${lastDay}`;
                });

                const currentMemberPlan = computed(() => {
                    if (!selectedMember.value || !personalPlans.value[selectedMember.value]) return '';
                    return personalPlans.value[selectedMember.value][currentWeekNum.value] || '';
                });

                const timerProgress = computed(() => (currentSeconds.value % 3600) / 3600);

                const selectMember = (m) => {
                    selectedMember.value = m;
                    form.value.name = m;
                    tempPlan.value = currentMemberPlan.value;
                    loadData();
                };

                const formatTime = (s) => {
                    const mins = Math.floor(s / 60);
                    const secs = s % 60;
                    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                };

                const formatTotalTime = (s) => (s / 3600).toFixed(1);

                const toggleTimer = () => {
                    if (isRunning.value) { clearInterval(timerInterval.value); }
                    else { timerInterval.value = setInterval(() => { currentSeconds.value++; totalSeconds.value++; saveData(); }, 1000); }
                    isRunning.value = !isRunning.value;
                };

                const addManualTime = () => { totalSeconds.value += manualHours.value * 3600; manualHours.value = 0; showToast.value = true; setTimeout(() => showToast.value = false, 2000); saveData(); };

                const addDailyLog = () => {
                    if (!dailyInput.value) return;
                    const log = {
                        date: customDate.value,
                        content: dailyInput.value,
                        completion: dailyCompletion.value,
                        weakPoint: dailyWeakPoint.value,
                        gapReason: dailyGapReason.value
                    };
                    dailyLogs.value.push(log);
                    dailyInput.value = '';
                    dailyWeakPoint.value = '';
                    dailyGapReason.value = '';
                    showToast.value = true;
                    setTimeout(() => showToast.value = false, 2000);
                    saveData();
                };

                const updatePersonalPlan = async () => {
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({ action: 'updatePlan', name: selectedMember.value, week: currentWeekNum.value, topic: tempPlan.value })
                        });
                        if (!personalPlans.value[selectedMember.value]) personalPlans.value[selectedMember.value] = {};
                        personalPlans.value[selectedMember.value][currentWeekNum.value] = tempPlan.value;
                        isEditingPlan.value = false;
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                    } catch (e) { alert('更新失敗'); }
                };

                const fetchInitialData = async () => {
                    try {
                        const res = await fetch(`${scriptURL}?action=getInitialData`);
                        const data = await res.json();
                        personalPlans.value = data.personalPlans;
                        statsList.value = data.statsList;
                        nextTick(() => renderChart());
                    } catch (e) { console.error('獲取資料失敗', e); }
                };

                const renderChart = () => {
                    const ctx = document.getElementById('completionChart');
                    if (!ctx) return;
                    if (chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: statsList.value.map(m => m.name),
                            datasets: [{
                                label: '本週達成率 (%)',
                                data: statsList.value.map(m => m.completionRate),
                                backgroundColor: 'rgba(185, 28, 28, 0.8)',
                                borderRadius: 10
                            }]
                        },
                        options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } }
                    });
                };

                const submitToGoogleSheets = async () => {
                    isSubmitting.value = true;
                    const data = { 
                        ...form.value, 
                        totalHours: formatTotalTime(totalSeconds.value), 
                        dailyLogs: JSON.stringify(dailyLogs.value), 
                        plan: currentMemberPlan.value,
                        reportDate: new Date().toISOString().substr(0, 10)
                    };
                    try {
                        await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                        showToast.value = true;
                        dailyLogs.value = [];
                        totalSeconds.value = 0;
                        saveData();
                        setTimeout(() => { showToast.value = false; activeTab.value = 'stats'; fetchInitialData(); }, 2000);
                    } catch (error) { alert('提交失敗'); }
                    finally { isSubmitting.value = false; }
                };

                const saveData = () => {
                    if (!selectedMember.value) return;
                    localStorage.setItem(`fire_v5_${selectedMember.value}`, JSON.stringify({
                        totalSeconds: totalSeconds.value,
                        dailyLogs: dailyLogs.value,
                        lastUpdate: new Date().toDateString()
                    }));
                };

                const loadData = () => {
                    const saved = localStorage.getItem(`fire_v5_${selectedMember.value}`);
                    if (saved) {
                        const data = JSON.parse(saved);
                        const today = new Date();
                        const day = today.getDay();
                        const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                        const startOfWeek = new Date(today.setDate(diff));
                        startOfWeek.setHours(0,0,0,0);
                        if (new Date(data.lastUpdate) < startOfWeek) {
                            totalSeconds.value = 0;
                            dailyLogs.value = [];
                        } else {
                            totalSeconds.value = data.totalSeconds || 0;
                            dailyLogs.value = data.dailyLogs || [];
                        }
                    } else {
                        totalSeconds.value = 0;
                        dailyLogs.value = [];
                    }
                };

                watch(dailyLogs, (newLogs) => {
                    form.value.actual = newLogs.map(l => `[${l.date}] ${l.content}`).join('\n');
                    const totalComp = newLogs.reduce((acc, curr) => acc + parseFloat(curr.completion || 0), 0);
                    form.value.completionRate = newLogs.length > 0 ? (totalComp / newLogs.length).toFixed(0) : 0;
                    form.value.weakPoint = [...new Set(newLogs.map(l => l.weakPoint).filter(w => w))].join('; ');
                    form.value.gapReason = [...new Set(newLogs.map(l => l.gapReason).filter(g => g))].join('; ');
                }, { deep: true });

                watch(activeTab, (newTab) => { if (newTab === 'stats') nextTick(() => renderChart()); });

                onMounted(() => { fetchInitialData(); });

                return {
                    activeTab, selectedMember, members, timerMode, isRunning, currentSeconds, totalSeconds, manualHours,
                    timerProgress, form, dailyInput, dailyCompletion, dailyWeakPoint, dailyGapReason, customDate, dailyLogs, personalPlans, statsList, isEditingPlan, tempPlan,
                    currentWeekNum, currentWeekRange, currentMemberPlan,
                    selectMember, formatTime, formatTotalTime, toggleTimer, addManualTime, addDailyLog, updatePersonalPlan, submitToGoogleSheets, fetchInitialData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
