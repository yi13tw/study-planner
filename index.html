<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消防設備士備考旗艦終極版 v15 (取消連帶回報)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto+Sans+TC', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 1); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .progress-ring { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .loading-spinner { border: 2px solid #f3f3f3; border-top: 2px solid #ef4444; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; cursor: pointer; background: #fee2e2; border-radius: 10px; }
        input[type=range]::-webkit-slider-thumb { height: 24px; width: 24px; border-radius: 50%; background: #ef4444; cursor: pointer; -webkit-appearance: none; margin-top: -8px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen shadow-2xl bg-slate-50">
    <div id="app" class="flex flex-col min-h-screen relative">

        <!-- Member Selection Overlay -->
        <div v-if="!selectedMember" class="fixed inset-0 z-[100] bg-slate-900/95 flex flex-col items-center justify-center p-8 animate-fade-in">
            <h1 class="text-white text-2xl font-black mb-8 tracking-widest uppercase">Who are you?</h1>
            <div class="grid grid-cols-2 gap-4 w-full">
                <button v-for="m in members" :key="m" @click="selectMember(m)"
                        class="py-6 bg-white/10 border border-white/20 rounded-3xl text-white font-bold hover:bg-white/20 transition-all active:scale-95">
                    {{ m }}
                </button>
            </div>
        </div>

        <!-- Header -->
        <header class="bg-red-800 text-white p-5 sticky top-0 z-50 shadow-lg rounded-b-[2.5rem]">
            <div class="flex justify-between items-center">
                <div @click="selectedMember = null" class="cursor-pointer">
                    <h1 class="text-xl font-black tracking-tight">{{ selectedMember }} 的儀表板</h1>
                    <div class="flex items-center mt-1">
                        <span class="bg-white/20 px-2 py-0.5 rounded text-[9px] font-bold uppercase mr-2">ULTIMATE v15</span>
                        <span class="text-[10px] text-red-100 opacity-80">切換成員 <i class="fas fa-chevron-down ml-1"></i></span>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs font-black uppercase tracking-widest">WEEK {{ currentWeekNum }}</div>
                    <div class="text-[9px] text-red-200 mt-1">當前進度</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4 pb-28 overflow-y-auto space-y-5">

            <!-- Tab 1: Dashboard (儀表板) -->
            <div v-show="activeTab === 'dashboard'" class="space-y-5 animate-fade-in">

                <!-- 個人化計畫 -->
                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[10px] font-black text-red-600 uppercase tracking-widest">WEEK {{ currentWeekNum }} 個人計畫</span>
                        <button @click="isEditingPlan = !isEditingPlan" class="text-slate-400 text-[10px] font-bold uppercase">
                            {{ isEditingPlan ? '取消' : '滾動修正' }}
                        </button>
                    </div>
                    <div v-if="!isEditingPlan">
                        <h2 class="text-xl font-bold text-slate-800 leading-tight whitespace-pre-line">{{ getPlanByWeek(currentWeekNum) || '尚未設定本週計畫' }}</h2>
                    </div>
                    <div v-else class="space-y-3">
                        <textarea v-model="tempPlan" rows="4" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-red-600"></textarea>
                        <button @click="updatePersonalPlan" :disabled="isSubmitting" class="w-full py-2 bg-slate-800 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest flex items-center justify-center">
                            <div v-if="isSubmitting" class="loading-spinner mr-2"></div>
                            {{ isSubmitting ? '儲存中...' : '儲存修正' }}
                        </button>
                    </div>
                </div>

                <!-- 專注計時 (僅在當週顯示) -->
                <div v-if="viewWeek === currentWeekNum" class="glass-card rounded-[2.5rem] p-6 shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-slate-800 uppercase text-sm tracking-wider">專注計時</h3>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button @click="timerMode = 'auto'" :class="timerMode === 'auto' ? 'bg-white shadow-sm text-red-600' : 'text-slate-400'" class="px-3 py-1 rounded-lg text-[10px] font-bold transition-all">自動</button>
                            <button @click="timerMode = 'manual'" :class="timerMode === 'manual' ? 'bg-white shadow-sm text-red-600' : 'text-slate-400'" class="px-3 py-1 rounded-lg text-[10px] font-bold transition-all">手動</button>
                        </div>
                    </div>

                    <div v-if="timerMode === 'auto'" class="text-center">
                        <div class="relative w-40 h-40 mx-auto mb-6 flex items-center justify-center">
                            <svg class="w-full h-full progress-ring">
                                <circle cx="80" cy="80" r="74" stroke="currentColor" stroke-width="4" fill="transparent" class="text-slate-100" />
                                <circle cx="80" cy="80" r="74" stroke="currentColor" stroke-width="6" fill="transparent" class="text-red-600"
                                        :stroke-dasharray="465" :stroke-dashoffset="465 * (1 - timerProgress)" stroke-linecap="round" />
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-3xl font-mono font-black text-slate-800">{{ formatTime(currentSeconds) }}</span>
                                <div class="flex flex-col space-y-1 mt-1">
                                    <button @click="toggleTimer" :class="isRunning ? 'text-orange-500' : 'text-red-600'" class="text-[10px] font-black uppercase tracking-widest">
                                        {{ isRunning ? 'PAUSE' : 'START' }}
                                    </button>
                                    <button v-if="!isRunning && currentSeconds > 0"
                                            @click="submitTimerOnly()"
                                            :disabled="isSubmitting"
                                            class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter flex items-center justify-center">
                                        <div v-if="isSubmitting" class="loading-spinner mr-1 w-2 h-2"></div>
                                        {{ isSubmitting ? '提交中...' : '提交時數' }}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-else class="space-y-4 py-2">
                        <div class="flex items-center justify-center space-x-4">
                            <button @click="manualHours = Math.max(0, manualHours - 0.5)" class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600">-</button>
                            <input v-model="manualHours" type="number" step="0.5" class="w-20 text-2xl font-black text-center bg-transparent outline-none">
                            <button @click="manualHours += 0.5" class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600">+</button>
                        </div>
                        <button @click="addManualTime" :disabled="isSubmitting" class="w-full py-3 bg-slate-800 text-white rounded-xl text-[10px] font-bold uppercase tracking-widest flex items-center justify-center">
                            <div v-if="isSubmitting" class="loading-spinner mr-2"></div>
                            {{ isSubmitting ? '提交中...' : '提交時數' }}
                        </button>
                    </div>
                </div>

                <!-- 每日輕回報 (僅在當週顯示) -->
                <div v-if="viewWeek === currentWeekNum" class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-200 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-black text-slate-800 text-sm uppercase tracking-wider flex items-center">
                            <i class="fas fa-bolt text-yellow-500 mr-2"></i> 每日輕回報
                        </h3>
                        <input type="date" v-model="customDate" class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-lg outline-none">
                    </div>

                    <textarea v-model="dailyInput" rows="2" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-2 focus:ring-red-600 outline-none text-sm transition-all" placeholder="今天讀了什麼？"></textarea>

                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[9px] font-black text-slate-400 uppercase">今日完成率: <span class="text-red-600 text-xs">{{ dailyCompletion }}%</span></label>
                            </div>
                            <input v-model="dailyCompletion" type="range" min="1" max="100" class="w-full">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-[9px] font-black text-slate-400 uppercase mb-1">今日不熟觀念</label>
                                <input v-model="dailyWeakPoint" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                            </div>
                            <div>
                                <label class="block text-[9px] font-black text-slate-400 uppercase mb-1">落差原因</label>
                                <input v-model="dailyGapReason" type="text" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm">
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                        <span class="text-[10px] font-bold text-slate-500">需要讀書會支援？</span>
                        <div class="flex space-x-2">
                            <button @click="dailyNeedSupport = false" :class="!dailyNeedSupport ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400'" class="px-3 py-1 rounded-lg text-[9px] font-black transition-all">否</button>
                            <button @click="dailyNeedSupport = true" :class="dailyNeedSupport ? 'bg-red-600 text-white' : 'text-slate-400'" class="px-3 py-1 rounded-lg text-[9px] font-black transition-all">是</button>
                        </div>
                    </div>

                    <div v-if="dailyNeedSupport">
                        <input v-model="dailySupportDetail" type="text" class="w-full p-3 bg-red-50 border border-red-100 rounded-xl text-sm" placeholder="請說明需要的支援...">
                    </div>

                    <button @click="addDailyLog"
                            :disabled="isSubmitting"
                            class="w-full py-4 bg-red-600 text-white rounded-2xl text-xs font-bold shadow-md active:scale-95 transition-all flex items-center justify-center">
                        <div v-if="isSubmitting" class="loading-spinner mr-2 border-t-white"></div>
                        {{ isSubmitting ? '提交中...' : '記錄今日進度' }}
                    </button>
                </div>
            </div>

            <!-- Tab 2: Weekly Report -->
            <div v-show="activeTab === 'report'" class="space-y-4 animate-fade-in">
                <div class="bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-200">

                    <div class="flex justify-between items-center mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                        <div>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">查看歷史數據</div>
                            <div class="text-[9px] text-slate-400 mt-1">{{ currentWeekRange }}</div>
                        </div>
                        <select v-model="viewWeek" class="bg-white border border-slate-200 text-slate-800 text-xs font-black rounded-xl px-4 py-2 outline-none shadow-sm">
                            <option :value="0">WEEK 0</option>
                            <option v-for="w in 20" :key="w" :value="w">WEEK {{ w }}</option>
                        </select>
                    </div>

                    <div class="p-6 bg-slate-900 rounded-[2rem] text-white mb-6">
                        <label class="block text-[10px] font-black text-red-400 uppercase tracking-widest mb-2">下週預計進度 (自動連動)</label>
                        <div class="text-lg font-bold">{{ nextMemberPlan || '尚未設定下週計畫' }}</div>
                    </div>

                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-black text-slate-800">數據總覽</h2>
                        <button @click="fetchInitialData" class="text-red-600 text-[10px] font-bold uppercase tracking-widest bg-red-50 px-3 py-1 rounded-full">Refresh</button>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-4 bg-slate-50 rounded-2xl">
                            <div class="text-[9px] font-black text-slate-400 uppercase mb-1">本週總時數</div>
                            <div class="text-xl font-black text-slate-800">{{ currentMemberStats.totalHours || 0 }} HR</div>
                        </div>
                        <div class="p-4 bg-red-50 rounded-2xl">
                            <div class="text-[9px] font-black text-red-400 uppercase mb-1">平均完成率</div>
                            <div class="text-xl font-black text-red-600">{{ currentMemberStats.completionRate || 0 }}%</div>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">本週規劃進度</label>
                            <div class="p-4 bg-slate-50 rounded-2xl text-sm font-bold text-slate-700 whitespace-pre-line">{{ currentMemberPlan }}</div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">本週進度彙整 (自動)</label>
                            <div class="p-4 bg-slate-50 rounded-2xl text-sm leading-relaxed text-slate-600 whitespace-pre-line min-h-[100px]">
                                {{ currentMemberStats.actual || '尚未有每日回報' }}
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">累計不熟觀念</label>
                                <div class="p-4 bg-red-50 rounded-2xl text-xs text-red-700 min-h-[60px]">{{ currentMemberStats.weakPoint || '無' }}</div>
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">累計落差原因</label>
                                <div class="p-4 bg-slate-50 rounded-2xl text-xs text-slate-500 min-h-[60px]">{{ currentMemberStats.gapReason || '無' }}</div>
                            </div>
                        </div>

                        <div v-if="currentMemberStats.needSupport" class="p-4 bg-yellow-50 border border-yellow-100 rounded-2xl">
                            <div class="text-[10px] font-black text-yellow-600 uppercase mb-1">⚠️ 需要讀書會支援 (累計)</div>
                            <div class="text-sm text-yellow-800">{{ currentMemberStats.supportDetail }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Stats -->
            <div v-show="activeTab === 'stats'" class="space-y-5 animate-fade-in">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-xl font-black text-slate-800 uppercase tracking-wider">本週戰況看板</h2>
                    <div class="flex items-center space-x-2">
                        <div v-if="hasNewData" class="text-[9px] font-black text-red-600 animate-pulse">● 有新數據</div>
                        <button @click="fetchInitialData" :disabled="isSubmitting" class="text-red-600 text-[10px] font-bold uppercase tracking-widest bg-red-50 px-3 py-1 rounded-full flex items-center">
                            <div v-if="isSubmitting" class="loading-spinner mr-1 w-3 h-3"></div>
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-200">
                    <canvas id="completionChart"></canvas>
                </div>

                <div class="space-y-4">
                    <div v-for="(member, index) in sortedStatsList" :key="index" class="bg-white rounded-[2rem] p-6 shadow-sm border border-slate-200">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-2xl bg-red-700 text-white flex items-center justify-center font-black mr-3 shadow-lg">{{ index + 1 }}</div>
                                <div>
                                    <div class="font-black text-slate-800 text-lg">{{ member.name }}</div>
                                    <div class="text-[9px] text-slate-400 font-bold uppercase">戰力值: {{ member.powerScore.toFixed(1) }}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-red-600">{{ member.totalHours }}<span class="text-[10px] ml-1">HR</span></div>
                                <div class="text-[9px] text-slate-400 font-bold uppercase">達成率 {{ member.completionRate }}%</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-2 mt-4">
                            <div class="p-3 bg-slate-50 rounded-xl text-[11px]">
                                <span class="font-black text-slate-400 uppercase block mb-1">本週進度彙整</span>
                                <div class="text-slate-600 whitespace-pre-line">{{ member.actual || '尚未回報' }}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div class="p-3 bg-red-50 rounded-xl text-[11px]">
                                    <span class="font-black text-red-400 uppercase block mb-1">不熟觀念</span>
                                    <div class="text-red-700">{{ member.weakPoint || '無' }}</div>
                                </div>
                                <div class="p-3 bg-slate-50 rounded-xl text-[11px]">
                                    <span class="font-black text-slate-400 uppercase block mb-1">落差原因</span>
                                    <div class="text-slate-500">{{ member.gapReason || '無' }}</div>
                                </div>
                            </div>
                            <div v-if="member.needSupport" class="p-3 bg-yellow-50 border border-yellow-100 rounded-xl text-[11px]">
                                <span class="font-black text-yellow-600 uppercase block mb-1">⚠️ 需要支援</span>
                                <div class="text-yellow-800">{{ member.supportDetail }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/95 backdrop-blur-md border-t border-slate-200 flex justify-around items-center py-4 px-8 safe-area-bottom z-50 rounded-t-[2.5rem] shadow-2xl">
            <button @click="activeTab = 'dashboard'" :class="activeTab === 'dashboard' ? 'text-red-700' : 'text-slate-300'" class="flex flex-col items-center transition-all">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[8px] mt-1 font-black uppercase tracking-widest">Home</span>
            </button>
            <button @click="activeTab = 'report'" :class="activeTab === 'report' ? 'text-red-700' : 'text-slate-300'" class="flex flex-col items-center transition-all">
                <i class="fas fa-edit text-xl"></i>
                <span class="text-[8px] mt-1 font-black uppercase tracking-widest">Report</span>
            </button>
            <button @click="activeTab = 'stats'" :class="activeTab === 'stats' ? 'text-red-700' : 'text-slate-300'" class="flex flex-col items-center transition-all">
                <i class="fas fa-chart-bar text-xl"></i>
                <span class="text-[8px] mt-1 font-black uppercase tracking-widest">Stats</span>
            </button>
        </nav>

        <!-- Success Toast -->
        <div v-if="showToast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-full shadow-2xl z-[100] flex items-center animate-fade-in">
            <i class="fas fa-check-circle text-green-400 mr-3"></i>
            <span class="text-xs font-black uppercase tracking-widest">Success</span>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const activeTab = ref('dashboard');
                const selectedMember = ref(null);
                const members = ['kurt', '郁舒', '和憲', '宜姍'];
                const timerMode = ref('auto');
                const isRunning = ref(false);
                const currentSeconds = ref(0);
                const totalSeconds = ref(0);
                const manualHours = ref(0);
                const timerInterval = ref(null);
                const showToast = ref(false);
                const isSubmitting = ref(false);
                const isEditingPlan = ref(false);
                const tempPlan = ref('');
                const hasNewData = ref(false);
                const viewWeek = ref(1);

                const dailyInput = ref('');
                const dailyCompletion = ref(100);
                const dailyWeakPoint = ref('');
                const dailyGapReason = ref('');
                const dailyNeedSupport = ref(false);
                const dailySupportDetail = ref('');
                const customDate = ref(new Date().toLocaleDateString('sv-SE'));

                const personalPlans = ref({});
                const statsList = ref([]);
                let chartInstance = null;

                const scriptURL = 'https://script.google.com/macros/s/AKfycbyiY2cCfoy-ncZs6keXPrKXs_yDIo1W0c73pi6DE1eoK7qGNZhUjp_NnRGuvYXj2u-f/exec';

                const currentWeekNum = computed(() => {
                    const start = new Date('2025-12-29T00:00:00+08:00');
                    const week1Start = new Date('2026-01-05T00:00:00+08:00');
                    const now = new Date();

                    if (now >= start && now < week1Start) return 0;

                    if (now >= week1Start) {
                        const diffTime = now - week1Start;
                        const diffDays = Math.floor(diffTime / (24 * 60 * 60 * 1000));
                        return Math.floor(diffDays / 7) + 1;
                    }

                    return 0;
                });

                const currentWeekRange = computed(() => {
                    let targetStart, targetEnd;

                    if (viewWeek.value === 0) {
                        targetStart = new Date('2025-12-29');
                        targetEnd = new Date('2026-01-04');
                    } else {
                        const week1Start = new Date('2026-01-05');
                        const daysOffset = (viewWeek.value - 1) * 7;
                        targetStart = new Date(week1Start.getTime() + daysOffset * 24 * 60 * 60 * 1000);
                        targetEnd = new Date(targetStart.getTime() + 6 * 24 * 60 * 60 * 1000);
                    }

                    return `${targetStart.toLocaleDateString('zh-TW', {month:'short', day:'numeric'})} - ${targetEnd.toLocaleDateString('zh-TW', {month:'short', day:'numeric'})}`;
                });

                const getPlanByWeek = (w) => {
                    if (!selectedMember.value || !personalPlans.value[selectedMember.value]) return '';
                    return personalPlans.value[selectedMember.value][w] || '';
                };

                const currentMemberPlan = computed(() => getPlanByWeek(currentWeekNum.value));
                const nextMemberPlan = computed(() => getPlanByWeek(viewWeek.value + 1));

                const targetWeek = computed(() => {
                    if (activeTab.value === 'dashboard') return currentWeekNum.value;
                    return viewWeek.value;
                });

                const filteredStatsList = computed(() => {
                    return statsList.value.filter(m => parseInt(m.week) === targetWeek.value);
                });

                const currentMemberStats = computed(() => {
                    if (!selectedMember.value) return {};
                    return filteredStatsList.value.find(m => m.name === selectedMember.value) || {};
                });

                const sortedStatsList = computed(() => {
                    const maxHours = Math.max(...filteredStatsList.value.map(m => parseFloat(m.totalHours) || 0), 1);
                    return filteredStatsList.value.map(m => ({
                        ...m,
                        powerScore: (parseFloat(m.completionRate) + (parseFloat(m.totalHours) / maxHours) * 100) / 2
                    })).sort((a, b) => b.powerScore - a.powerScore);
                });

                const timerProgress = computed(() => (currentSeconds.value % 3600) / 3600);

                const selectMember = (m) => {
                    selectedMember.value = m;
                    viewWeek.value = currentWeekNum.value; // ✅ 預設當週
                    tempPlan.value = getPlanByWeek(currentWeekNum.value);
                    loadData();
                    fetchInitialData();
                };

                const formatTime = (s) => {
                    const mins = Math.floor(s / 60);
                    const secs = s % 60;
                    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                };

                const formatTotalTime = (s) => (s / 3600).toFixed(1);

                const toggleTimer = () => {
                    if (isRunning.value) {
                        clearInterval(timerInterval.value);
                    } else {
                        timerInterval.value = setInterval(() => {
                            currentSeconds.value++;
                            totalSeconds.value++;
                            saveData();
                        }, 1000);
                    }
                    isRunning.value = !isRunning.value;
                };

                // ✅ 取消連帶回報：移除 shouldPrompt/confirm 邏輯
                const submitTimerOnly = async () => {
                    isSubmitting.value = true;
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'submitDaily',
                                name: selectedMember.value,
                                date: customDate.value,
                                totalHours: formatTotalTime(totalSeconds.value),
                                plan: currentMemberPlan.value,
                                content: '',
                                completion: '',
                                gapReason: '',
                                weakPoint: '',
                                needSupport: false,
                                supportDetail: ''
                            })
                        });

                        currentSeconds.value = 0;
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                        hasNewData.value = true;
                        fetchInitialData();
                    } catch (e) {
                        alert('提交失敗');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const addManualTime = async () => {
                    totalSeconds.value += manualHours.value * 3600;
                    manualHours.value = 0;
                    await submitTimerOnly();
                    saveData();
                };

                // ✅ 取消連帶回報：移除 shouldPrompt/confirm 邏輯
                const addDailyLog = async () => {
                    if (!dailyInput.value) { alert('請填寫今日進度內容'); return; }
                    isSubmitting.value = true;

                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'submitDaily',
                                name: selectedMember.value,
                                date: customDate.value,
                                totalHours: formatTotalTime(totalSeconds.value),
                                plan: currentMemberPlan.value,
                                content: dailyInput.value,
                                completion: dailyCompletion.value,
                                weakPoint: dailyWeakPoint.value,
                                gapReason: dailyGapReason.value,
                                needSupport: dailyNeedSupport.value,
                                supportDetail: dailySupportDetail.value
                            })
                        });

                        dailyInput.value = '';
                        dailyWeakPoint.value = '';
                        dailyGapReason.value = '';
                        dailyNeedSupport.value = false;
                        dailySupportDetail.value = '';
                        dailyCompletion.value = 100;
                        customDate.value = new Date().toISOString().substr(0, 10);

                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                        hasNewData.value = true;
                        saveData();
                        fetchInitialData();
                    } catch (e) {
                        alert('提交失敗');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const updatePersonalPlan = async () => {
                    isSubmitting.value = true;
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({ action: 'updatePlan', name: selectedMember.value, week: viewWeek.value, topic: tempPlan.value })
                        });
                        if (!personalPlans.value[selectedMember.value]) personalPlans.value[selectedMember.value] = {};
                        personalPlans.value[selectedMember.value][viewWeek.value] = tempPlan.value;
                        isEditingPlan.value = false;
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                    } catch (e) {
                        alert('更新失敗');
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const fetchInitialData = async () => {
                    isSubmitting.value = true;
                    try {
                        const res = await fetch(`${scriptURL}?action=getInitialData`);
                        const data = await res.json();
                        personalPlans.value = data.personalPlans;
                        statsList.value = data.statsList;
                        hasNewData.value = false;
                        nextTick(() => renderChart());
                    } catch (e) {
                        console.error('獲取資料失敗', e);
                    } finally {
                        isSubmitting.value = false;
                    }
                };

                const renderChart = () => {
                    const ctx = document.getElementById('completionChart');
                    if (!ctx) return;
                    if (chartInstance) chartInstance.destroy();

                    const chartData = sortedStatsList.value;

                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: chartData.map(m => m.name),
                            datasets: [
                                { label: '達成率 (%)', data: chartData.map(m => m.completionRate), backgroundColor: 'rgba(185, 28, 28, 0.8)', borderRadius: 5, yAxisID: 'y' },
                                { label: '總時數 (HR)', data: chartData.map(m => m.totalHours), backgroundColor: 'rgba(30, 41, 59, 0.8)', borderRadius: 5, yAxisID: 'y1' }
                            ]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: { type: 'linear', position: 'left', beginAtZero: true, max: 100, title: { display: true, text: '達成率 (%)' } },
                                y1: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, title: { display: true, text: '時數 (HR)' } }
                            }
                        }
                    });
                };

                const saveData = () => {
                    if (!selectedMember.value) return;
                    localStorage.setItem(`fire_v15_${selectedMember.value}`, JSON.stringify({
                        totalSeconds: totalSeconds.value,
                        lastUpdate: new Date().toDateString()
                    }));
                };

                const loadData = () => {
                    const saved = localStorage.getItem(`fire_v15_${selectedMember.value}`);
                    if (saved) {
                        const data = JSON.parse(saved);
                        const today = new Date();
                        const day = today.getDay();
                        const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                        const startOfWeek = new Date(today.setDate(diff));
                        startOfWeek.setHours(0,0,0,0);
                        if (new Date(data.lastUpdate) < startOfWeek) { totalSeconds.value = 0; }
                        else { totalSeconds.value = data.totalSeconds || 0; }
                    } else {
                        totalSeconds.value = 0;
                    }
                };

                watch(activeTab, (newTab) => {
                    if (newTab === 'stats' || newTab === 'report') fetchInitialData();
                    if (newTab === 'dashboard') viewWeek.value = currentWeekNum.value; // ✅ 切回 Home 同步當週
                });

                watch(viewWeek, () => {
                    tempPlan.value = getPlanByWeek(viewWeek.value);
                    nextTick(() => renderChart());
                });

                onMounted(() => {
                    fetchInitialData();
                    viewWeek.value = currentWeekNum.value; // ✅ 預設當週（查看歷史數據）
                    setInterval(() => {
                        const now = new Date().toLocaleDateString('sv-SE');
                        if (customDate.value !== now) customDate.value = now;
                    }, 60000);
                });

                return {
                    activeTab, selectedMember, members, timerMode, isRunning, currentSeconds, totalSeconds, manualHours,
                    timerProgress, dailyInput, dailyCompletion, dailyWeakPoint, dailyGapReason, dailyNeedSupport, dailySupportDetail, customDate,
                    personalPlans, statsList, sortedStatsList, isEditingPlan, tempPlan, hasNewData, isSubmitting, viewWeek,
                    currentWeekNum, currentWeekRange, currentMemberPlan, nextMemberPlan, currentMemberStats, getPlanByWeek,
                    selectMember, formatTime, formatTotalTime, toggleTimer, submitTimerOnly, addManualTime, addDailyLog, updatePersonalPlan, fetchInitialData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
