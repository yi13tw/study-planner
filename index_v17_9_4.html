<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>讀書會進度追蹤系統 v17.9.4</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
        
        :root {
            --primary: #e11d48;
            --primary-dark: #9f1239;
            --bg-main: #f8fafc;
            --card-bg: #ffffff;
        }

        body { 
            font-family: 'Inter', 'Noto+Sans+TC', sans-serif; 
            background-color: var(--bg-main); 
            color: #1e293b;
            -webkit-tap-highlight-color: transparent; 
            line-height: 1.5;
            font-size: 16px;
        }

        .app-card { 
            background: var(--card-bg); 
            border-radius: 1.25rem; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            border: 1px solid #f1f5f9;
        }

        .glass-header {
            background: #9f1239;
            box-shadow: 0 4px 20px rgba(159, 18, 57, 0.15);
        }

        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .loading-spinner { 
            border: 2px solid rgba(255,255,255,0.3); 
            border-top: 2px solid white; 
            border-radius: 50%; 
            width: 16px; height: 16px; 
            animation: spin 0.8s linear infinite; 
        }
        .loading-spinner-red { 
            border: 2px solid #fee2e2; 
            border-top: 2px solid #e11d48; 
            border-radius: 50%; 
            width: 16px; height: 16px; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 0px; background: transparent; }

        .member-btn { 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            transition: all 0.2s ease; 
        }
        .member-btn:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.1); }
        .gradient-bg { background: radial-gradient(circle at top right, #4c0519, #0f172a); }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { height: 6px; background: #f1f5f9; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 22px; width: 22px; 
            background: var(--primary); border-radius: 50%; margin-top: -8px; 
            box-shadow: 0 2px 5px rgba(225, 29, 72, 0.2);
        }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen shadow-2xl overflow-x-hidden">
    <div id="app" class="flex flex-col min-h-screen relative">
        
        <!-- Member Selection Overlay -->
        <div v-if="!selectedMember" class="fixed inset-0 z-[100] gradient-bg flex flex-col items-center justify-center p-8 animate-slide-up">
            <div class="mb-10 text-center">
                <div class="w-20 h-20 bg-rose-600 rounded-[2rem] mx-auto mb-5 flex items-center justify-center shadow-2xl shadow-rose-900/40 rotate-6">
                    <i class="fas fa-book-open text-white text-3xl"></i>
                </div>
                <h1 class="text-white text-3xl font-black tracking-tight mb-2">Who are you?</h1>
                <p class="text-slate-400 text-xs font-medium tracking-wide opacity-70">請選擇您的成員身份以開始</p>
            </div>
            
            <div v-if="isLoadingMembers" class="flex flex-col items-center">
                <div class="loading-spinner w-10 h-10 mb-4"></div>
                <span class="text-slate-500 text-[9px] font-bold uppercase tracking-[0.3em]">正在同步讀書會名單...</span>
            </div>
            
            <div v-else class="grid grid-cols-2 gap-4 w-full max-w-xs">
                <button v-for="m in filteredMembers" :key="m" @click="selectMember(m)" 
                    class="member-btn py-8 rounded-[2rem] text-white flex flex-col items-center justify-center space-y-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-rose-500 to-rose-700 flex items-center justify-center text-xl font-black shadow-lg">
                        {{ m.charAt(0) }}
                    </div>
                    <span class="font-bold text-lg tracking-wide">{{ m }}</span>
                </button>
            </div>
            
            <div class="mt-12 text-slate-600 text-[9px] font-bold uppercase tracking-[0.4em]">
                讀書會進度追蹤系統
            </div>
        </div>

        <!-- Header -->
        <header class="glass-header text-white p-4 sticky top-0 z-50 rounded-b-[2rem]">
            <div class="flex justify-between items-center">
                <div @click="selectedMember = null" class="cursor-pointer group">
                    <h1 class="text-xl font-black tracking-tighter group-active:scale-95 transition-transform">{{ selectedMember }}</h1>
                    <div class="flex items-center mt-0.5">
                        <span class="bg-white/20 px-1.5 py-0.5 rounded text-[8px] font-black uppercase mr-1.5 tracking-tighter">v17.9.4</span>
                        <span class="text-[10px] text-rose-100 opacity-70 font-medium">切換成員 <i class="fas fa-chevron-down ml-0.5 text-[7px]"></i></span>
                    </div>
                </div>
                <div class="text-right">
                    <div v-if="activeTab !== 'dashboard'">
                        <div class="flex flex-col items-end">
                            <div class="flex items-center space-x-2">
                                <span v-if="viewWeek < currentWeekNum" class="bg-slate-800/50 text-[9px] font-black px-1.5 py-0.5 rounded text-slate-300 uppercase">歷史數據</span>
                                <span v-else-if="viewWeek === currentWeekNum" class="bg-green-500/80 text-[9px] font-black px-1.5 py-0.5 rounded text-white uppercase">當前進度</span>
                                <div class="relative inline-block">
                                    <select v-model="viewWeek" class="appearance-none bg-rose-800/50 text-white text-[12px] font-black rounded-lg pl-2 pr-7 py-1 outline-none border border-white/10">
                                        <option v-for="w in 53" :key="w-1" :value="w-1">WEEK {{ w-1 }}</option>
                                    </select>
                                    <i class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[8px] pointer-events-none opacity-50"></i>
                                </div>
                            </div>
                            <div class="text-[10px] text-rose-200 mt-1 font-bold tracking-tight">{{ currentWeekRange }}</div>
                        </div>
                    </div>
                    <div v-else>
                        <div class="text-[12px] font-black bg-rose-800/50 border border-white/10 px-3 py-1 rounded-lg inline-block">WEEK {{ currentWeekNum }}</div>
                        <div class="text-[10px] text-rose-200 mt-1 font-bold tracking-tight">{{ currentWeekRange }}</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4 pb-28 overflow-y-auto space-y-4">
            
            <!-- Tab 1: Dashboard (Home) -->
            <div v-show="activeTab === 'dashboard'" class="space-y-4 animate-slide-up">
                <!-- Weekly Plan Card -->
                <div class="app-card p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-1.5 h-4 bg-rose-600 rounded-full mr-2"></div>
                            <span class="text-[13px] font-black text-slate-400 uppercase tracking-widest">本週計畫</span>
                        </div>
                        <button @click="isEditingPlan = !isEditingPlan" class="text-rose-600 text-[10px] font-black uppercase tracking-widest bg-rose-50 px-2 py-0.5 rounded-full">
                            {{ isEditingPlan ? '取消' : '修正' }}
                        </button>
                    </div>
                    <div v-if="!isEditingPlan">
                        <h2 class="text-base font-bold text-slate-800 leading-relaxed whitespace-pre-line">{{ getPlanByWeek(currentWeekNum) || '尚未設定本週計畫' }}</h2>
                    </div>
                    <div v-else class="space-y-3">
                        <textarea v-model="tempPlan" rows="3" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-base outline-none focus:ring-2 focus:ring-rose-500 transition-all"></textarea>
                        <button @click="updatePersonalPlan" :disabled="isSubmitting" class="w-full py-3 bg-slate-900 text-white rounded-xl text-[11px] font-black uppercase tracking-widest flex items-center justify-center shadow-md">
                            <div v-if="isSubmitting" class="loading-spinner mr-2"></div>
                            {{ isSubmitting ? '儲存中...' : '儲存修正' }}
                        </button>
                    </div>
                </div>

                <!-- Timer Card -->
                <div class="app-card p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-black text-slate-800 uppercase text-[13px] tracking-widest">專注計時</h3>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button @click="timerMode = 'auto'" :class="timerMode === 'auto' ? 'bg-white shadow-sm text-rose-600' : 'text-slate-400'" class="px-3 py-1 rounded-lg text-[10px] font-black transition-all">自動</button>
                            <button @click="timerMode = 'manual'" :class="timerMode === 'manual' ? 'bg-white shadow-sm text-rose-600' : 'text-slate-400'" class="px-3 py-1 rounded-lg text-[10px] font-black transition-all">手動</button>
                        </div>
                    </div>
                    
                    <div v-if="timerMode === 'auto'" class="flex items-center justify-around py-2">
                        <div class="relative w-36 h-36 flex items-center justify-center">
                            <svg class="absolute w-full h-full transform -rotate-90">
                                <circle cx="72" cy="72" r="60" stroke="#f1f5f9" stroke-width="8" fill="none"></circle>
                                <circle cx="72" cy="72" r="60" stroke="#e11d48" stroke-width="8" fill="none" 
                                    :stroke-dasharray="377" 
                                    :stroke-dashoffset="377 * (1 - timerProgress)" 
                                    class="transition-all duration-1000"></circle>
                            </svg>
                            <div class="text-center z-10">
                                <div class="text-3xl font-black text-slate-800">{{ formatTime(currentSeconds) }}</div>
                                <div class="text-[9px] font-black text-slate-300 uppercase tracking-widest mt-1">{{ formatTotalTime(totalSeconds) }} HR</div>
                            </div>
                        </div>
                        <div class="flex flex-col space-y-2">
                            <button @click="toggleTimer" :class="isRunning ? 'bg-rose-600 text-white' : 'bg-slate-900 text-white'" class="w-24 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-md active:scale-95 transition-all">
                                {{ isRunning ? 'PAUSE' : 'START' }}
                            </button>
                            <button v-if="!isRunning && currentSeconds > 0" @click="submitTimerOnly()" :disabled="isSubmitting" class="w-24 py-2 bg-slate-100 text-slate-400 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center">
                                <div v-if="isSubmitting" class="loading-spinner-red mr-1"></div>
                                <span v-if="!isSubmitting">提交時數</span>
                            </button>
                        </div>
                    </div>
                    
                    <div v-else class="flex items-center justify-between py-3 px-4">
                        <div class="flex items-center space-x-4">
                            <button @click="manualHours = Math.max(0, manualHours - 0.5)" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 text-lg font-bold">-</button>
                            <div class="text-center">
                                <input v-model="manualHours" type="number" step="0.5" class="w-14 text-2xl font-black text-center bg-transparent outline-none text-slate-800">
                                <div class="text-[9px] font-black text-slate-300 uppercase">Hrs</div>
                            </div>
                            <button @click="manualHours += 0.5" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 text-lg font-bold">+</button>
                        </div>
                        <button @click="addManualTime" :disabled="isSubmitting" class="px-6 py-3 bg-slate-900 text-white rounded-xl text-[11px] font-black uppercase tracking-widest shadow-md flex items-center justify-center">
                            <div v-if="isSubmitting" class="loading-spinner mr-2"></div>
                            <span v-if="!isSubmitting">提交</span>
                        </button>
                    </div>
                </div>

                <!-- Daily Report Card -->
                <div class="app-card p-4 space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-black text-slate-800 text-[13px] tracking-widest flex items-center">
                            <i class="fas fa-feather-alt text-rose-500 mr-2"></i> 每日輕回報
                        </h3>
                        <input type="date" v-model="customDate" class="text-[11px] font-black text-slate-500 bg-slate-50 px-2 py-1 rounded-lg outline-none">
                    </div>
                    
                    <textarea v-model="dailyInput" rows="2" class="w-full p-4 bg-slate-50 border border-slate-50 rounded-xl focus:ring-2 focus:ring-rose-500 outline-none text-base transition-all placeholder:text-slate-300" placeholder="今天完成了哪些進度？"></textarea>
                    
                    <div class="grid grid-cols-1 gap-4">
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">今日完成率</label>
                                <span class="text-rose-600 font-black text-base">{{ dailyCompletion }}%</span>
                            </div>
                            <input v-model="dailyCompletion" type="range" min="1" max="100" class="w-full">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1.5">
                                <label class="text-[12px] font-black text-slate-500 uppercase tracking-widest ml-1">不熟觀念</label>
                                <input v-model="dailyWeakPoint" type="text" class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm outline-none focus:ring-1 focus:ring-rose-200" placeholder="例如：法規第3條">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[12px] font-black text-slate-500 uppercase tracking-widest ml-1">落差原因</label>
                                <input v-model="dailyGapReason" type="text" class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm outline-none focus:ring-1 focus:ring-rose-200" placeholder="例如：加班、分心">
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-rose-50/30 rounded-xl border border-rose-100/30">
                        <span class="text-[11px] font-black text-rose-900/50 uppercase">是否需要讀書會支援</span>
                        <div class="flex space-x-2">
                            <button @click="dailyNeedSupport = false" :class="!dailyNeedSupport ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400'" class="px-4 py-1.5 rounded-lg text-[10px] font-black transition-all">否</button>
                            <button @click="dailyNeedSupport = true" :class="dailyNeedSupport ? 'bg-rose-600 text-white shadow-md' : 'text-slate-400'" class="px-4 py-1.5 rounded-lg text-[10px] font-black transition-all">是</button>
                        </div>
                    </div>
                    
                    <div v-if="dailyNeedSupport" class="animate-slide-up">
                        <input v-model="dailySupportDetail" type="text" class="w-full p-3 bg-rose-50 border border-rose-100 rounded-xl text-sm outline-none" placeholder="請說明需要的支援...">
                    </div>

                    <button @click="addDailyLog()" :disabled="isSubmitting" class="w-full py-4 bg-rose-600 text-white rounded-xl text-[13px] font-black shadow-lg shadow-rose-100 active:scale-[0.98] transition-all flex items-center justify-center">
                        <div v-if="isSubmitting" class="loading-spinner mr-3"></div>
                        {{ isSubmitting ? '正在提交...' : '記錄今日進度' }}
                    </button>
                </div>
            </div>

            <!-- Tab 2: Weekly Report -->
            <div v-show="activeTab === 'report'" class="space-y-4 animate-slide-up">
                <div class="app-card p-4">
                    <div class="p-5 bg-slate-900 rounded-2xl text-white mb-5 shadow-lg relative overflow-hidden">
                        <label class="block text-[10px] font-black text-rose-400 uppercase tracking-widest mb-2">下週預計進度</label>
                        <div class="text-base font-bold leading-relaxed whitespace-pre-line">{{ nextMemberPlan || '尚未設定下週計畫' }}</div>
                    </div>

                    <div class="flex justify-between items-end mb-5 px-1">
                        <div>
                            <h2 class="text-xl font-black text-slate-800 tracking-tighter">數據總覽</h2>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">WEEK {{ viewWeek }}</p>
                        </div>
                        <button @click="fetchInitialData" :disabled="isSubmitting" class="flex items-center space-x-2 bg-slate-50 px-3 py-1.5 rounded-xl border border-slate-100 active:scale-95 transition-all">
                            <div v-if="isSubmitting" class="loading-spinner-red"></div>
                            <i v-else class="fas fa-sync-alt text-rose-600 text-[11px]"></i>
                            <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">{{ isSubmitting ? '同步中' : 'Refresh' }}</span>
                        </button>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-5">
                        <div class="p-4 bg-slate-50 rounded-xl border border-slate-100">
                            <div class="text-[9px] font-black text-slate-400 uppercase mb-1">本週總時數</div>
                            <div class="text-2xl font-black text-slate-800">{{ currentMemberStats.totalHours || 0 }} <span class="text-xs text-slate-300">HR</span></div>
                        </div>
                        <div class="p-4 bg-rose-50 rounded-xl border border-rose-100">
                            <div class="text-[9px] font-black text-rose-400 uppercase mb-1">平均達成率</div>
                            <div class="text-2xl font-black text-rose-600">{{ currentMemberStats.completionRate || 0 }}<span class="text-xs opacity-50">%</span></div>
                        </div>
                    </div>

                    <div class="space-y-5">
                        <section>
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 ml-1">本週規劃進度</label>
                            <div class="p-4 bg-slate-50 rounded-xl text-base font-bold text-slate-700 whitespace-pre-line leading-relaxed">{{ currentMemberPlan }}</div>
                        </section>

                        <section>
                            <label class="text-[12px] font-black text-slate-400 uppercase tracking-widest block mb-2 ml-1">本週進度彙整</label>
                            <div class="p-4 bg-white border border-slate-100 rounded-xl text-base leading-relaxed text-slate-600 whitespace-pre-line min-h-[80px]">
                                {{ currentMemberStats.actual || '尚未有每日回報' }}
                            </div>
                        </section>

                        <div class="grid grid-cols-1 gap-3">
                            <div class="p-4 bg-rose-50/30 rounded-xl border border-rose-100/50">
                                <label class="block text-[12px] font-black text-rose-400 uppercase tracking-widest mb-1.5">累計不熟觀念</label>
                                <div class="text-sm font-bold text-rose-900/70">{{ currentMemberStats.weakPoint || '無' }}</div>
                            </div>
                            <div class="p-4 bg-slate-50 rounded-xl">
                                <label class="block text-[12px] font-black text-slate-400 uppercase tracking-widest mb-1.5">累計落差原因</label>
                                <div class="text-sm font-bold text-slate-500">{{ currentMemberStats.gapReason || '無' }}</div>
                            </div>
                        </div>

                        <div v-if="currentMemberStats.needSupport" class="p-4 bg-amber-50 border border-amber-100 rounded-xl">
                            <div class="text-[10px] font-black text-amber-600 uppercase tracking-widest mb-1.5">⚠️ 需要讀書會支援</div>
                            <div class="text-sm font-bold text-amber-900">{{ currentMemberStats.supportDetail }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Stats -->
            <div v-show="activeTab === 'stats'" class="space-y-4 animate-slide-up">
                <div class="flex items-center justify-between px-1">
                    <div>
                        <h2 class="text-xl font-black text-slate-800 tracking-tighter">戰況看板</h2>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">WEEK {{ viewWeek }}</p>
                    </div>
                    <button @click="fetchInitialData" :disabled="isSubmitting" class="flex items-center space-x-2 bg-white px-3 py-1.5 rounded-xl shadow-sm border border-slate-100 active:scale-95 transition-all">
                        <div v-if="isSubmitting" class="loading-spinner-red"></div>
                        <i v-else class="fas fa-sync-alt text-rose-600 text-[11px]"></i>
                        <span class="text-[10px] font-black text-slate-600 uppercase tracking-widest">{{ isSubmitting ? '同步中' : 'Refresh' }}</span>
                    </button>
                </div>

                <div class="app-card p-4">
                    <canvas id="completionChart" class="max-h-[180px]"></canvas>
                </div>

                <div class="space-y-3">
                    <div v-for="(member, index) in sortedStatsList" :key="index" class="app-card p-4 relative overflow-hidden">
                        <div v-if="index === 0" class="absolute top-0 right-0 bg-rose-600 text-white text-[8px] font-black px-3 py-0.5 rounded-bl-lg uppercase tracking-widest">MVP</div>
                        
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-xl bg-slate-900 text-white flex items-center justify-center font-black text-lg mr-3 shadow-lg">
                                    {{ index + 1 }}
                                </div>
                                <div>
                                    <div class="font-black text-slate-800 text-base tracking-tight">{{ member.name }}</div>
                                    <div class="flex items-center mt-0.5">
                                        <div class="w-16 h-1.5 bg-slate-100 rounded-full mr-1.5 overflow-hidden">
                                            <div class="h-full bg-rose-500 rounded-full" :style="{width: member.completionRate + '%'}"></div>
                                        </div>
                                        <span class="text-[9px] text-slate-400 font-black uppercase">{{ member.completionRate }}%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-black text-rose-600 tracking-tighter">{{ member.totalHours }}<span class="text-xs ml-0.5 opacity-40">HR</span></div>
                            </div>
                        </div>

                        <div class="p-3 bg-slate-50 rounded-xl text-[14px] leading-relaxed">
                            <span class="font-black text-slate-300 uppercase text-[9px] block mb-1 tracking-widest">進度彙整</span>
                            <div class="text-slate-600 font-medium whitespace-pre-line">{{ member.actual || '尚未回報' }}</div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <div class="p-3 bg-rose-50/50 rounded-xl text-[12px]">
                                <span class="font-black text-rose-300 uppercase text-[9px] block mb-0.5 tracking-widest">不熟觀念</span>
                                <div class="text-rose-800 font-bold truncate">{{ member.weakPoint || '無' }}</div>
                            </div>
                            <div class="p-3 bg-slate-50 rounded-xl text-[12px]">
                                <span class="font-black text-slate-300 uppercase text-[9px] block mb-0.5 tracking-widest">落差原因</span>
                                <div class="text-slate-500 font-bold truncate">{{ member.gapReason || '無' }}</div>
                            </div>
                        </div>

                        <!-- Need Support Section in Stats -->
                        <div v-if="member.needSupport" class="mt-3 p-3 bg-amber-50 border border-amber-100 rounded-xl text-[12px]">
                            <span class="font-black text-amber-600 uppercase text-[9px] block mb-1 tracking-widest">⚠️ 需要讀書會支援</span>
                            <div class="text-amber-900 font-bold whitespace-pre-line">{{ member.supportDetail }}</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-slate-100 flex justify-around items-center py-3 px-2 safe-area-bottom shadow-2xl rounded-t-[2rem]">
            <button @click="activeTab = 'dashboard'" :class="activeTab === 'dashboard' ? 'text-rose-600 scale-110' : 'text-slate-300'" class="flex flex-col items-center space-y-1 transition-all active:scale-95">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[9px] font-black uppercase tracking-widest">Home</span>
            </button>
            <button @click="activeTab = 'report'" :class="activeTab === 'report' ? 'text-rose-600 scale-110' : 'text-slate-300'" class="flex flex-col items-center space-y-1 transition-all active:scale-95">
                <i class="fas fa-clipboard-list text-xl"></i>
                <span class="text-[9px] font-black uppercase tracking-widest">Report</span>
            </button>
            <button @click="activeTab = 'stats'" :class="activeTab === 'stats' ? 'text-rose-600 scale-110' : 'text-slate-300'" class="flex flex-col items-center space-y-1 transition-all active:scale-95">
                <i class="fas fa-chart-bar text-xl"></i>
                <span class="text-[9px] font-black uppercase tracking-widest">Stats</span>
            </button>
        </nav>

        <!-- Toast Notification -->
        <div v-if="showToast" class="fixed top-24 left-1/2 -translate-x-1/2 z-[200] bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl text-sm font-black uppercase tracking-widest animate-slide-up">
            ✓ 提交成功
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const scriptURL = 'https://script.google.com/macros/s/AKfycbwx1mECFbuTRWo4gTWUXVtQNWJfpP-B2rzJUEDPv3DLhVXabRejWoLpgQdvjdEGWyxW/exec';
                
                const activeTab = ref('dashboard');
                const selectedMember = ref(null);
                const members = ref([]);
                const isLoadingMembers = ref(true);
                const timerMode = ref('auto');
                const isRunning = ref(false);
                const currentSeconds = ref(0);
                const totalSeconds = ref(0);
                const manualHours = ref(0);
                const timerInterval = ref(null);
                const dailyInput = ref('');
                const dailyCompletion = ref(100);
                const dailyWeakPoint = ref('');
                const dailyGapReason = ref('');
                const dailyNeedSupport = ref(false);
                const dailySupportDetail = ref('');
                const customDate = ref(new Date().toLocaleDateString('en-CA'));
                const personalPlans = ref({});
                const statsList = ref([]);
                const isEditingPlan = ref(false);
                const tempPlan = ref('');
                const showToast = ref(false);
                const hasNewData = ref(false);
                const isSubmitting = ref(false);
                const viewWeek = ref(0);
                let chartInstance = null;

                const filteredMembers = computed(() => members.value.filter(m => m !== '全體'));

                const serverStartDateStr = ref('2025-12-29'); // 預設值，會被後端傳回的值覆蓋

                const currentWeekNum = computed(() => {
                    // 修正：前端週次計算應與後端 START_DATE 保持一致
                    const START_DATE = new Date(serverStartDateStr.value + 'T00:00:00+08:00');
                    const now = new Date();
                    const diff = now.getTime() - START_DATE.getTime();
                    const week = Math.floor(diff / (7 * 24 * 60 * 60 * 1000));
                    return week >= 0 ? week : 0;
                });

                const currentWeekRange = computed(() => {
                    const now = new Date();
                    const day = now.getDay();
                    const diff = now.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(now.setDate(diff));
                    const sunday = new Date(monday);
                    sunday.setDate(monday.getDate() + 6);
                    return `${monday.getMonth()+1}/${monday.getDate()} - ${sunday.getMonth()+1}/${sunday.getDate()}`;
                });

                const getPlanByWeek = (week) => {
                    if (!selectedMember.value || !personalPlans.value[selectedMember.value]) return '';
                    return personalPlans.value[selectedMember.value][week] || '';
                };

                const currentMemberPlan = computed(() => getPlanByWeek(viewWeek.value));
                const nextMemberPlan = computed(() => getPlanByWeek(viewWeek.value + 1));

                const currentMemberStats = computed(() => {
                    const found = statsList.value.find(s => s.name === selectedMember.value);
                    return found || { totalHours: 0, completionRate: 0, actual: '', weakPoint: '', gapReason: '', needSupport: false, supportDetail: '' };
                });

                const sortedStatsList = computed(() => {
                    return [...statsList.value].sort((a, b) => {
                        if (b.completionRate !== a.completionRate) return b.completionRate - a.completionRate;
                        return b.totalHours - a.totalHours;
                    });
                });

                const timerProgress = computed(() => (currentSeconds.value % 3600) / 3600);

                const selectMember = (m) => {
                    selectedMember.value = m;
                    viewWeek.value = currentWeekNum.value;
                    tempPlan.value = getPlanByWeek(currentWeekNum.value);
                    loadData();
                };

                const formatTime = (s) => {
                    const mins = Math.floor(s / 60);
                    const secs = s % 60;
                    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                };

                const formatTotalTime = (s) => (s / 3600).toFixed(1);

                const toggleTimer = () => {
                    if (isRunning.value) { clearInterval(timerInterval.value); }
                    else { timerInterval.value = setInterval(() => { currentSeconds.value++; totalSeconds.value++; saveData(); }, 1000); }
                    isRunning.value = !isRunning.value;
                };

                const submitTimerOnly = async () => {
                    if (totalSeconds.value <= 0) return;
                    isSubmitting.value = true;
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'submitDaily',
                                name: selectedMember.value,
                                totalHours: formatTotalTime(totalSeconds.value),
                                plan: getPlanByWeek(currentWeekNum.value),
                                isTimerOnly: true,
                                completion: 0,
                                content: '',
                                gapReason: '',
                                weakPoint: '',
                                needSupport: false,
                                supportDetail: ''
                            })
                        });
                        currentSeconds.value = 0;
                        totalSeconds.value = 0; // 修正 Bug 2: 提交後重置累積時數
                        saveData();
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                        hasNewData.value = true;
                        fetchInitialData();
                    } catch (e) { alert('提交失敗'); }
                    finally { isSubmitting.value = false; }
                };

                const addManualTime = async () => {
                    const hours = manualHours.value;
                    if (hours <= 0) return;
                    isSubmitting.value = true;
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'submitDaily',
                                name: selectedMember.value,
                                date: new Date().toISOString(), // 明確傳遞當前日期，確保週數計算正確
                                totalHours: hours.toFixed(1),
                                plan: getPlanByWeek(currentWeekNum.value),
                                isTimerOnly: true,
                                completion: 0,
                                content: '',
                                gapReason: '',
                                weakPoint: '',
                                needSupport: false,
                                supportDetail: ''
                            })
                        });
                        manualHours.value = 0;
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                        hasNewData.value = true;
                        fetchInitialData();
                    } catch (e) { alert('提交失敗'); }
                    finally { isSubmitting.value = false; }
                };

                const addDailyLog = async () => {
                    if (!dailyInput.value) { alert('請填寫今日進度內容'); return; }
                    isSubmitting.value = true;
                    try {
                        // 修正 Bug 3: 每日日誌提交時，只提交計時器當前累積的時數，並在提交後重置
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({
                                action: 'submitDaily',
                                name: selectedMember.value,
                                date: customDate.value,
                                totalHours: formatTotalTime(totalSeconds.value),
                                plan: getPlanByWeek(currentWeekNum.value),
                                content: dailyInput.value,
                                completion: dailyCompletion.value,
                                weakPoint: dailyWeakPoint.value,
                                gapReason: dailyGapReason.value,
                                needSupport: dailyNeedSupport.value,
                                supportDetail: dailySupportDetail.value,
                                isTimerOnly: false
                            })
                        });
                        totalSeconds.value = 0; // 提交後重置
                        currentSeconds.value = 0;
                        saveData();
                        
                        dailyInput.value = '';
                        dailyWeakPoint.value = '';
                        dailyGapReason.value = '';
                        dailyNeedSupport.value = false;
                        dailySupportDetail.value = '';
                        dailyCompletion.value = 100;
                        customDate.value = new Date().toLocaleDateString('en-CA');
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                        hasNewData.value = true;
                        fetchInitialData();
                    } catch (e) { alert('提交失敗'); }
                    finally { isSubmitting.value = false; }
                };

                const updatePersonalPlan = async () => {
                    isSubmitting.value = true;
                    try {
                        await fetch(scriptURL, {
                            method: 'POST',
                            mode: 'no-cors',
                            body: JSON.stringify({ action: 'updatePlan', name: selectedMember.value, week: currentWeekNum.value, topic: tempPlan.value })
                        });
                        if (!personalPlans.value[selectedMember.value]) personalPlans.value[selectedMember.value] = {};
                        personalPlans.value[selectedMember.value][currentWeekNum.value] = tempPlan.value;
                        isEditingPlan.value = false;
                        showToast.value = true;
                        setTimeout(() => showToast.value = false, 2000);
                    } catch (e) { alert('更新失敗'); }
                    finally { isSubmitting.value = false; }
                };

                const fetchInitialData = async () => {
                    isSubmitting.value = true;
                    try {
                        const res = await fetch(`${scriptURL}?action=getInitialData&week=${viewWeek.value}`);
                        const data = await res.json();
                        personalPlans.value = data.personalPlans;
                        statsList.value = data.statsList;
                        members.value = data.members;
                        if (data.startDateStr) serverStartDateStr.value = data.startDateStr; // 同步後端的起始日期
                        isLoadingMembers.value = false;
                        hasNewData.value = false;
                        nextTick(() => renderChart());
                    } catch (e) { console.error('獲取資料失敗', e); }
                    finally { isSubmitting.value = false; }
                };

                const renderChart = () => {
                    const ctx = document.getElementById('completionChart');
                    if (!ctx) return;
                    if (chartInstance) chartInstance.destroy();
                    chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: statsList.value.map(m => m.name),
                            datasets: [
                                { label: '達成率 (%)', data: statsList.value.map(m => m.completionRate), backgroundColor: 'rgba(225, 29, 72, 0.8)', borderRadius: 8, yAxisID: 'y' },
                                { label: '時數 (HR)', data: statsList.value.map(m => m.totalHours), backgroundColor: 'rgba(15, 23, 42, 0.8)', borderRadius: 8, yAxisID: 'y1' }
                            ]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { font: { weight: 'bold', size: 9 } } } },
                            scales: { 
                                y: { type: 'linear', position: 'left', beginAtZero: true, max: 100, grid: { display: false }, ticks: { font: { size: 9 } } },
                                y1: { type: 'linear', position: 'right', beginAtZero: true, grid: { display: false }, ticks: { font: { size: 9 } } },
                                x: { grid: { display: false }, ticks: { font: { weight: 'bold', size: 10 } } }
                            } 
                        }
                    });
                };

                const saveData = () => {
                    if (!selectedMember.value) return;
                    localStorage.setItem(`fire_v17_${selectedMember.value}`, JSON.stringify({
                        totalSeconds: totalSeconds.value,
                        lastUpdate: new Date().toDateString()
                    }));
                };

                const loadData = () => {
                    const saved = localStorage.getItem(`fire_v17_${selectedMember.value}`);
                    if (saved) {
                        const data = JSON.parse(saved);
                        const today = new Date();
                        const day = today.getDay();
                        const diff = today.getDate() - day + (day === 0 ? -6 : 1);
                        const startOfWeek = new Date(today.setDate(diff));
                        startOfWeek.setHours(0,0,0,0);
                        if (new Date(data.lastUpdate) < startOfWeek) { totalSeconds.value = 0; } 
                        else { totalSeconds.value = data.lastUpdate ? data.totalSeconds : 0; }
                    } else { totalSeconds.value = 0; }
                };

                watch(activeTab, (newTab) => { 
                    if (newTab === 'dashboard') viewWeek.value = currentWeekNum.value;
                    fetchInitialData(); 
                });
                watch(viewWeek, () => { fetchInitialData(); });

                onMounted(async () => { 
                    await fetchInitialData();
                    viewWeek.value = currentWeekNum.value;
                    setInterval(() => {
                        const now = new Date().toLocaleDateString('en-CA');
                        if (customDate.value !== now && !isSubmitting.value) customDate.value = now;
                    }, 60000);
                });

                return {
                    activeTab, selectedMember, members, filteredMembers, isLoadingMembers, timerMode, isRunning, currentSeconds, totalSeconds, manualHours,
                    timerProgress, dailyInput, dailyCompletion, dailyWeakPoint, dailyGapReason, dailyNeedSupport, dailySupportDetail, customDate, personalPlans, statsList, sortedStatsList, isEditingPlan, tempPlan, hasNewData, isSubmitting, viewWeek,
                    currentWeekNum, currentWeekRange, currentMemberPlan, nextMemberPlan, currentMemberStats, getPlanByWeek,
                    selectMember, formatTime, formatTotalTime, toggleTimer, submitTimerOnly, addManualTime, addDailyLog, updatePersonalPlan, fetchInitialData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
